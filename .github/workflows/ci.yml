name: Multi-Platform CI/CD Pipeline

on:
  push:
    branches: [ devel, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ devel, main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - release
        - dist
      create_release:
        description: 'Create GitHub Release (ä»…å½“build_typeä¸ºreleaseæ—¶ç”Ÿæ•ˆ)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  actions: read

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx4096m -Xms2048m -XX:+UseG1GC -XX:MaxMetaspaceSize=512m'
  JAVA_TOOL_OPTIONS: '-Dfile.encoding=UTF-8'
  BUILD_TIMEOUT: 90

jobs:
  # åŸºç¡€æ„å»ºå’Œæµ‹è¯•ä½œä¸š (ç®€åŒ–ç‰ˆ)
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        server-id: github-maven
        server-username: GITHUB_ACTOR
        server-password: GITHUB_TOKEN

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Extract version
      id: version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ Project version: $VERSION"

    - name: Check if should release
      id: check-release
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "ğŸš€ This is a release build"
        elif [[ "${{ github.event.inputs.build_type }}" == "release" || "${{ github.event.inputs.build_type }}" == "dist" ]]; then
          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "ğŸš€ Manual release build requested"
        else
          echo "should-release=false" >> $GITHUB_OUTPUT
          echo "ğŸ”¨ This is a development build"
        fi

    - name: Skip tests for faster build
      run: |
        echo "âš¡ Skipping tests for faster build..."

    - name: Download and install license file (å¯é€‰)
      run: |
        if [ -n "${{ secrets.LICENSE_DOWNLOAD_URL }}" ]; then
          echo "ğŸ“¥ æ­£åœ¨ä»è‡ªå®šä¹‰URLä¸‹è½½license.jar..."
          mkdir -p lib/
          if curl -L --fail "${{ secrets.LICENSE_DOWNLOAD_URL }}" -o lib/license.jar; then
            echo "âœ… è‡ªå®šä¹‰license.jarä¸‹è½½æˆåŠŸ"
            mvn install:install-file -Dfile=lib/license.jar -DgroupId=org.tinymediamanager -DartifactId=license -Dversion=5.2.1 -Dpackaging=jar
            echo "å°†ä½¿ç”¨æœ¬åœ°license.jarè¿›è¡Œæ„å»º"
          else
            echo "âš ï¸ è‡ªå®šä¹‰license.jarä¸‹è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨tinyMediaManagerå®˜æ–¹ç‰ˆæœ¬"
          fi
        else
          echo "âš ï¸ LICENSE_DOWNLOAD_URLæœªé…ç½®ï¼Œå°†ä½¿ç”¨tinyMediaManagerå®˜æ–¹ç‰ˆæœ¬"
        fi

    - name: Build JAR
      run: |
        echo "ğŸ”¨ Building JAR with performance optimizations..."
        mvn clean package --batch-mode -T 2 -DskipTests=true -Dmaven.test.skip=true -DskipSign=true -Pgithub-ci
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC -XX:+UseStringDeduplication"

    - name: Upload base JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tinymediamanager-jar-${{ steps.version.outputs.version }}
        path: target/*.jar
        retention-days: 30



  # å¤šå¹³å°æ„å»ºä½œä¸š (ç®€åŒ–ç‰ˆ)
  build-platforms:
    name: Build for ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    needs: build-and-test
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/devel'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: "Windows x64"
            os: windows-latest
            assembly: windows-amd64
            artifact-name: windows-amd64
            native-path: native/windows
          - name: "Linux x64"
            os: ubuntu-latest
            assembly: linux-amd64
            artifact-name: linux-amd64
            native-path: native/linux
          - name: "Linux ARM64"
            os: ubuntu-latest
            assembly: linux-arm64
            artifact-name: linux-arm64
            native-path: native/arm
          - name: "macOS x64"
            os: macos-13
            assembly: macos-x86_64
            artifact-name: macos-x86_64
            native-path: native/mac
          - name: "macOS ARM64"
            os: macos-latest
            assembly: macos-aarch64
            artifact-name: macos-aarch64
            native-path: native/mac

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        server-id: github-maven
        server-username: GITHUB_ACTOR
        server-password: GITHUB_TOKEN

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Verify native libraries
      run: |
        echo "ğŸ” Checking native libraries for ${{ matrix.platform.name }}..."
        if [ -d "${{ matrix.platform.native-path }}" ]; then
          echo "âœ… Native libraries found:"
          ls -la ${{ matrix.platform.native-path }}/
        else
          echo "âš ï¸ No native libraries found for this platform"
        fi
      shell: bash

    - name: Download and install license file (å¯é€‰)
      run: |
        if [ -n "${{ secrets.LICENSE_DOWNLOAD_URL }}" ]; then
          echo "ğŸ“¥ æ­£åœ¨ä»è‡ªå®šä¹‰URLä¸‹è½½license.jar for ${{ matrix.platform.name }}..."
          mkdir -p lib/
          if curl -L --fail "${{ secrets.LICENSE_DOWNLOAD_URL }}" -o lib/license.jar; then
            echo "âœ… è‡ªå®šä¹‰license.jarä¸‹è½½æˆåŠŸ"
            mvn install:install-file -Dfile=lib/license.jar -DgroupId=org.tinymediamanager -DartifactId=license -Dversion=5.2.1 -Dpackaging=jar
            echo "å°†ä½¿ç”¨æœ¬åœ°license.jarè¿›è¡Œæ„å»º"
          else
            echo "âš ï¸ è‡ªå®šä¹‰license.jarä¸‹è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨tinyMediaManagerå®˜æ–¹ç‰ˆæœ¬"
          fi
        else
          echo "âš ï¸ LICENSE_DOWNLOAD_URLæœªé…ç½®ï¼Œå°†ä½¿ç”¨tinyMediaManagerå®˜æ–¹ç‰ˆæœ¬"
        fi
      shell: bash

    - name: Build platform distribution
      run: |
        echo "ğŸ—ï¸ Building distribution for ${{ matrix.platform.name }} with optimizations..."
        echo "ğŸ“‹ Using Maven profile: ${{ matrix.platform.assembly }}"
        echo "âš¡ Performance: 2 threads, optimized JVM, incremental build"
        mvn package -Pdist,${{ matrix.platform.assembly }} --batch-mode -T 2 -DskipTests=true -Dmaven.test.skip=true -DskipSign=true -Dmaven.javadoc.skip=true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MAVEN_OPTS: "-Xmx3g -XX:+UseG1GC -XX:+UseStringDeduplication -XX:+UseCompressedOops"
      shell: bash

    - name: Create platform package
      run: |
        echo "ğŸ“¦ Creating platform package for ${{ matrix.platform.name }}..."
        echo "ğŸ” Looking for files matching pattern: tinyMediaManager-*-${{ matrix.platform.assembly }}.*"
        ls -la dist/

        # Check for any file matching the platform pattern
        if ls dist/tinyMediaManager-*-${{ matrix.platform.assembly }}.* 1> /dev/null 2>&1; then
          echo "âœ… Package created successfully for ${{ matrix.platform.name }}"
          echo "ğŸ“ Found files:"
          ls -la dist/tinyMediaManager-*-${{ matrix.platform.assembly }}.*
        else
          echo "âŒ No package found for ${{ matrix.platform.assembly }}"
          echo "ğŸ“ Available files in dist/:"
          ls -la dist/ || echo "No dist directory found"
          exit 1
        fi
      shell: bash

    - name: Create professional macOS DMG (GitLab-style, unsigned)
      if: startsWith(matrix.platform.assembly, 'macos-')
      run: |
        set -e  # Exit on any error

        echo "ğŸ Creating professional macOS DMG for ${{ matrix.platform.name }}..."
        echo "ğŸ“‹ Using GitLab DMG creation method (without signing)"
        echo "âš ï¸  Note: This DMG will be unsigned (no Apple Developer account)"
        echo "ğŸ“‹ Users will need to manually allow the app: xattr -dr com.apple.quarantine tinyMediaManager.app"

        # Create temporary directory for DMG creation (GitLab style)
        mkdir -p macos_dmg_${{ matrix.platform.assembly }}
        cd macos_dmg_${{ matrix.platform.assembly }}

        # Extract the ZIP file (same as GitLab method) with error checking
        ZIP_FILE="../dist/tinyMediaManager-*-${{ matrix.platform.assembly }}.zip"
        if ! ls $ZIP_FILE 1> /dev/null 2>&1; then
          echo "âŒ Error: No ZIP file found matching pattern: $ZIP_FILE"
          exit 1
        fi

        echo "ğŸ“¦ Extracting ZIP file..."
        if ! unzip -q -X $ZIP_FILE -d tinyMediaManager; then
          echo "âŒ Error: Failed to extract ZIP file"
          exit 1
        fi

        # Verify app bundle exists
        if [[ ! -d "tinyMediaManager/tinyMediaManager.app" ]]; then
          echo "âŒ Error: tinyMediaManager.app not found in extracted files"
          echo "ğŸ“ Available files:"
          ls -la tinyMediaManager/ || true
          exit 1
        fi

        # Get version (same as GitLab method) with error checking
        VERSION_FILE="tinyMediaManager/tinyMediaManager.app/Contents/Resources/Java/version"
        if [[ ! -f "$VERSION_FILE" ]]; then
          echo "âŒ Error: Version file not found: $VERSION_FILE"
          exit 1
        fi

        VERSION=$(grep 'human.version' "$VERSION_FILE" | cut -d'=' -f2)
        if [[ -z "$VERSION" ]]; then
          echo "âŒ Error: Could not extract version from $VERSION_FILE"
          exit 1
        fi
        echo "ğŸ“¦ Version: $VERSION"

        # Create .userdir file (same as GitLab method)
        touch tinyMediaManager/tinyMediaManager.app/Contents/Resources/Java/.userdir

        # Fix critical macOS app permissions (GitLab does this automatically)
        echo "ğŸ”§ Fixing macOS app permissions and structure..."

        # Ensure the main executable has correct permissions
        MAIN_EXECUTABLE="tinyMediaManager/tinyMediaManager.app/Contents/MacOS/tinyMediaManager"
        if [[ -f "$MAIN_EXECUTABLE" ]]; then
          chmod +x "$MAIN_EXECUTABLE"
          echo "âœ… Set executable permissions for main app"
        else
          echo "âŒ Warning: Main executable not found at $MAIN_EXECUTABLE"
          echo "ğŸ“ Available files in MacOS directory:"
          ls -la "tinyMediaManager/tinyMediaManager.app/Contents/MacOS/" || echo "MacOS directory not found"
        fi

        # Ensure Info.plist exists and is readable
        INFO_PLIST="tinyMediaManager/tinyMediaManager.app/Contents/Info.plist"
        if [[ -f "$INFO_PLIST" ]]; then
          chmod 644 "$INFO_PLIST"
          echo "âœ… Set correct permissions for Info.plist"
          echo "ğŸ“‹ Info.plist CFBundleExecutable: $(plutil -extract CFBundleExecutable raw "$INFO_PLIST" 2>/dev/null || echo 'Not found')"
        else
          echo "âŒ Warning: Info.plist not found at $INFO_PLIST"
        fi

        # Set correct permissions for the entire app bundle
        chmod -R u+rw,go+r "tinyMediaManager/tinyMediaManager.app"
        find "tinyMediaManager/tinyMediaManager.app" -type d -exec chmod 755 {} \;
        echo "âœ… Set correct permissions for entire app bundle"

        # Create comprehensive auto-fix script for users using printf
        printf '#!/bin/bash\nset -e\n\necho "ğŸ› ï¸  tinyMediaManager macOS å®‰å…¨ä¿®å¤å·¥å…·"\necho "=================================="\necho ""\n\n# æŸ¥æ‰¾tinyMediaManager.app\nAPP_PATH=""\n\n# æ–¹æ³•1: æ£€æŸ¥å¸¸è§ä½ç½®\necho "ğŸ” æ­£åœ¨æœç´¢ tinyMediaManager.app..."\n\n# æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å¤¹\nif [[ -d "$HOME/Downloads/tinyMediaManager.app" ]]; then\n    APP_PATH="$HOME/Downloads/tinyMediaManager.app"\n    echo "âœ… åœ¨ä¸‹è½½æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°: $APP_PATH"\nelif [[ -d "$HOME/Desktop/tinyMediaManager.app" ]]; then\n    APP_PATH="$HOME/Desktop/tinyMediaManager.app"\n    echo "âœ… åœ¨æ¡Œé¢æ‰¾åˆ°: $APP_PATH"\nelif [[ -d "/Applications/tinyMediaManager.app" ]]; then\n    APP_PATH="/Applications/tinyMediaManager.app"\n    echo "âœ… åœ¨åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°: $APP_PATH"\nelse\n    # æ–¹æ³•2: æœç´¢æ•´ä¸ªç”¨æˆ·ç›®å½•\n    echo "ğŸ” æ­£åœ¨æœç´¢ç”¨æˆ·ç›®å½•..."\n    FOUND_APPS=$(find "$HOME" -name "tinyMediaManager.app" -type d 2>/dev/null | head -5)\n    \n    if [[ -n "$FOUND_APPS" ]]; then\n        echo "æ‰¾åˆ°ä»¥ä¸‹ tinyMediaManager.app:"\n        echo "$FOUND_APPS"\n        APP_PATH=$(echo "$FOUND_APPS" | head -1)\n        echo "ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„åº”ç”¨: $APP_PATH"\n    else\n        echo "âŒ æœªæ‰¾åˆ° tinyMediaManager.app"\n        echo ""\n        echo "ğŸ’¡ è¯·ç¡®ä¿ï¼š"\n        echo "1. å·²ä»DMGæ–‡ä»¶å¤åˆ¶ tinyMediaManager.app åˆ°æŸä¸ªä½ç½®"\n        echo "2. åº”ç”¨ç¨‹åºåç§°æ­£ç¡®"\n        echo ""\n        echo "ğŸ” æ‚¨å¯ä»¥ï¼š"\n        echo "- æ‰‹åŠ¨æ‹–æ‹½ tinyMediaManager.app åˆ° /Applications æ–‡ä»¶å¤¹"\n        echo "- æˆ–ä»DMGé‡æ–°å®‰è£…"\n        read -p "æŒ‰å›è½¦é”®é€€å‡º..."\n        exit 1\n    fi\nfi\n\necho ""\necho "ğŸ¯ ä¿®å¤ç›®æ ‡: $APP_PATH"\necho ""\n\n# æ­¥éª¤1: ç§»é™¤éš”ç¦»å±æ€§\necho "ğŸ”§ æ­¥éª¤ 1: ç§»é™¤éš”ç¦»å±æ€§..."\nif xattr -dr com.apple.quarantine "$APP_PATH" 2>/dev/null; then\n    echo "âœ… éš”ç¦»å±æ€§ç§»é™¤æˆåŠŸ"\nelif sudo xattr -dr com.apple.quarantine "$APP_PATH" 2>/dev/null; then\n    echo "âœ… éš”ç¦»å±æ€§ç§»é™¤æˆåŠŸ (éœ€è¦ç®¡ç†å‘˜æƒé™)"\nelse\n    echo "âš ï¸  éš”ç¦»å±æ€§ç§»é™¤å¤±è´¥ (å¯èƒ½å·²ç§»é™¤æˆ–ä¸éœ€è¦)"\nfi\n\n# æ­¥éª¤2: ä¿®å¤æ–‡ä»¶æƒé™\necho ""\necho "ğŸ”§ æ­¥éª¤ 2: ä¿®å¤æ–‡ä»¶æƒé™..."\n\n# ä¿®å¤ä¸»å¯æ‰§è¡Œæ–‡ä»¶\nMAIN_EXEC="$APP_PATH/Contents/MacOS/tinyMediaManager"\nif [[ -f "$MAIN_EXEC" ]]; then\n    chmod +x "$MAIN_EXEC" 2>/dev/null || sudo chmod +x "$MAIN_EXEC"\n    echo "âœ… ä¸»æ‰§è¡Œæ–‡ä»¶æƒé™å·²ä¿®å¤"\nelse\n    echo "âŒ æœªæ‰¾åˆ°ä¸»æ‰§è¡Œæ–‡ä»¶: $MAIN_EXEC"\nfi\n\n# ä¿®å¤Javaå¯æ‰§è¡Œæ–‡ä»¶\nJAVA_PATHS=(\n    "$APP_PATH/Contents/MacOS/jre/bin/java"\n    "$APP_PATH/Contents/MacOS/jre/Contents/Home/bin/java"\n    "$APP_PATH/Contents/PlugIns/jre/bin/java"\n)\n\nfor java_path in "${JAVA_PATHS[@]}"; do\n    if [[ -f "$java_path" ]]; then\n        chmod +x "$java_path" 2>/dev/null || sudo chmod +x "$java_path"\n        echo "âœ… Javaæ‰§è¡Œæ–‡ä»¶æƒé™å·²ä¿®å¤: $(basename "$java_path")"\n    fi\ndone\n\n# ä¿®å¤æ•´ä¸ªåº”ç”¨åŒ…æƒé™\nchmod -R u+rw,go+r "$APP_PATH" 2>/dev/null || sudo chmod -R u+rw,go+r "$APP_PATH"\nfind "$APP_PATH" -type d -exec chmod 755 {} \\; 2>/dev/null || sudo find "$APP_PATH" -type d -exec chmod 755 {} \\;\necho "âœ… åº”ç”¨åŒ…æƒé™å·²ç»Ÿä¸€ä¿®å¤"\n\n# æ­¥éª¤3: éªŒè¯åº”ç”¨ç¨‹åºå®Œæ•´æ€§\necho ""\necho "ğŸ”§ æ­¥éª¤ 3: éªŒè¯åº”ç”¨ç¨‹åºç»“æ„..."\n\nREQUIRED_FILES=(\n    "$APP_PATH/Contents/Info.plist"\n    "$APP_PATH/Contents/MacOS/tinyMediaManager"\n)\n\nALL_GOOD=true\nfor file in "${REQUIRED_FILES[@]}"; do\n    if [[ ! -e "$file" ]]; then\n        echo "âŒ ç¼ºå°‘å…³é”®æ–‡ä»¶: $file"\n        ALL_GOOD=false\n    fi\ndone\n\nif [[ "$ALL_GOOD" = true ]]; then\n    echo "âœ… åº”ç”¨ç¨‹åºç»“æ„å®Œæ•´"\nelse\n    echo "âš ï¸  åº”ç”¨ç¨‹åºå¯èƒ½å·²æŸå"\n    echo "ğŸ’¡ å»ºè®®é‡æ–°ä¸‹è½½æœ€æ–°ç‰ˆæœ¬"\nfi\n\necho ""\necho "ğŸ‰ ä¿®å¤å®Œæˆï¼"\necho ""\necho "ğŸš€ ç°åœ¨æ‚¨å¯ä»¥ï¼š"\necho "1. åŒå‡» $APP_PATH å¯åŠ¨"\necho "2. æˆ–å³é”®ç‚¹å‡»é€‰æ‹© '\''æ‰“å¼€'\''"\necho "3. å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·é‡å¯Mac"\necho ""\nread -p "æŒ‰å›è½¦é”®å…³é—­æ­¤çª—å£..."\n' > tinyMediaManager/Fix_macOS_Security.command

        # Make the script executable
        chmod +x tinyMediaManager/Fix_macOS_Security.command

        # Create a README for users using printf
        printf 'ğŸ tinyMediaManager for macOS (GitHub æ„å»ºç‰ˆæœ¬)\n==========================================\n\nâš ï¸  é‡è¦æç¤ºï¼šè¿™æ˜¯æ¥è‡ª GitHub Actions çš„æœªç­¾åæ„å»ºç‰ˆæœ¬ã€‚\nmacOS ä¼šåœ¨æ‚¨é¦–æ¬¡å°è¯•è¿è¡Œ tinyMediaManager.app æ—¶æ˜¾ç¤ºå®‰å…¨è­¦å‘Šã€‚\n\nğŸš€ å¿«é€Ÿä¿®å¤æ–¹æ³•ï¼ˆé€‰æ‹©å…¶ä¸­ä¸€ç§ï¼‰ï¼š\n\nâœ… æ–¹æ³• 1ï¼šåŒå‡» "Fix_macOS_Security.command" â­ æ¨è\n   - è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ä¿®å¤å®‰å…¨é—®é¢˜\n   - åªéœ€æŒ‰ç…§æç¤ºæ“ä½œå³å¯\n   - æ”¯æŒè‡ªåŠ¨æœç´¢åº”ç”¨ç¨‹åºä½ç½®\n\nâœ… æ–¹æ³• 2ï¼šå³é”®æ‰“å¼€\n   - å³é”®ç‚¹å‡» tinyMediaManager.app\n   - é€‰æ‹© "æ‰“å¼€"ï¼ˆä¸æ˜¯åŒå‡»ï¼‰\n   - åœ¨å®‰å…¨è­¦å‘Šä¸­ç‚¹å‡» "æ‰“å¼€"\n\nâœ… æ–¹æ³• 3ï¼šç»ˆç«¯å‘½ä»¤\n   - æ‰“å¼€ç»ˆç«¯ (Terminal)\n   - è¾“å…¥ï¼šxattr -dr com.apple.quarantine\n   - å°† tinyMediaManager.app æ‹–å…¥ç»ˆç«¯\n   - æŒ‰å›è½¦æ‰§è¡Œ\n\nâœ… æ–¹æ³• 4ï¼šç³»ç»Ÿè®¾ç½®\n   - å°è¯•æ‰“å¼€ tinyMediaManager.appï¼ˆä¼šå¤±è´¥ï¼‰\n   - å‰å¾€ ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ > é€šç”¨\n   - ç‚¹å‡» "ä»è¦æ‰“å¼€"ï¼ˆå¦‚æœå‡ºç°æç¤ºï¼‰\n\nğŸ¯ ä½¿ç”¨ä»»ä½•ä¸Šè¿°æ–¹æ³•åï¼ŒtinyMediaManager.app å°†æ­£å¸¸è¿è¡Œã€‚\n\nğŸ’¡ æç¤ºï¼šå¦‚æœæ‚¨ç»å¸¸ä½¿ç”¨ GitHub æ„å»ºçš„åº”ç”¨ï¼Œå»ºè®®ä½¿ç”¨æ–¹æ³• 1 çš„è‡ªåŠ¨ä¿®å¤è„šæœ¬ã€‚\n\nğŸ“ å¦‚éœ€æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼šhttps://github.com/jonntd/tinymediamanager\n\nğŸ”§ æ•…éšœæ’é™¤ï¼š\n- å¦‚æœä¿®å¤è„šæœ¬æ‰¾ä¸åˆ°åº”ç”¨ç¨‹åºï¼Œè¯·ç¡®ä¿å®ƒä»¬åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­\n- å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·å°è¯•é‡æ–°ä¸‹è½½æœ€æ–°ç‰ˆæœ¬\n- å¯¹äº macOS Ventura/Sonoma ç”¨æˆ·ï¼Œè¯·æŸ¥çœ‹ "ç³»ç»Ÿè®¾ç½®" è€Œä¸æ˜¯ "ç³»ç»Ÿåå¥½è®¾ç½®"\n' > tinyMediaManager/README_macOS.txt

        echo "ğŸ“¦ Creating professional DMG with GitLab styling..."

        # Copy DS_Store if available (for proper Finder layout)
        if [[ -f "../AppBundler/macos/DS_Store" ]]; then
          cp ../AppBundler/macos/DS_Store tinyMediaManager/.DS_Store
          echo "âœ… Applied Finder layout settings"
        fi

        # Copy auto-launch script if available
        if [[ -f "../AppBundler/macos/auto_launch.sh" ]]; then
          cp ../AppBundler/macos/auto_launch.sh tinyMediaManager/
          chmod +x tinyMediaManager/auto_launch.sh
          echo "âœ… Added auto-launch script"
        fi

        # Use GitLab's professional create-dmg tool if available
        if [[ -f "../AppBundler/macos/bin/create-dmg" && -f "../AppBundler/macos/background.png" ]]; then
          echo "ğŸ¨ Creating professional DMG with background and layout..."
          chmod +x ../AppBundler/macos/bin/create-dmg



          # Clean up any existing DMG and mounted volumes before creating
          rm -f tinyMediaManager.dmg
          # Force unmount any existing volumes with retry mechanism
          for i in {1..5}; do
            if hdiutil detach /Volumes/tinyMediaManager 2>/dev/null; then
              echo "âœ… Unmounted existing volume (attempt $i)"
              break
            fi
            echo "â³ Waiting for volume to unmount (attempt $i/5)..."
            sleep 3
          done

          # Additional cleanup for GitHub Actions
          sudo diskutil list | grep tinyMediaManager | awk '{print $1}' | xargs -I {} sudo diskutil unmount {} 2>/dev/null || true
          sleep 5

          # Build create-dmg arguments dynamically based on file existence
          DMG_ARGS=(
            --background ../AppBundler/macos/background.png
            --volname "tinyMediaManager"
            --window-pos 200 120
            --window-size 660 400
            --icon-size 100
            --app-drop-link 500 300
            --skip-jenkins
            --format UDBZ
          )

          # Add icon positioning for files that exist
          if [[ -d "tinyMediaManager/tinyMediaManager.app" ]]; then
            DMG_ARGS+=(--icon "tinyMediaManager.app" 160 180)
            DMG_ARGS+=(--hide-extension "tinyMediaManager.app")
            echo "âœ… Will position tinyMediaManager.app icon"
          fi

          # ä½¿ç”¨ç¾è§‚çš„Fix Securityåº”ç”¨
          if [[ -d "tinyMediaManager/ğŸ”§ Fix Security.app" ]]; then
            DMG_ARGS+=(--icon "ğŸ”§ Fix Security.app" 450 300)
            DMG_ARGS+=(--hide-extension "ğŸ”§ Fix Security.app")
            echo "âœ… Will position ğŸ”§ Fix Security.app as UI button (450, 300)"
          fi

          if [[ -f "tinyMediaManager/README_macOS.txt" ]]; then
            DMG_ARGS+=(--icon "README_macOS.txt" 320 180)
            echo "âœ… Will position README_macOS.txt icon"
          fi

          # Create DMG with dynamic arguments and retry mechanism
          DMG_SUCCESS=false
          for attempt in {1..3}; do
            echo "ğŸ”„ DMG creation attempt $attempt/3..."

            # Additional cleanup before each attempt
            rm -f tinyMediaManager.dmg
            sudo diskutil list | grep tinyMediaManager | awk '{print $1}' | xargs -I {} sudo diskutil unmount {} 2>/dev/null || true
            sleep 2

            if ../AppBundler/macos/bin/create-dmg "${DMG_ARGS[@]}" tinyMediaManager.dmg tinyMediaManager; then
              echo "âœ… Professional DMG created successfully on attempt $attempt"
              DMG_SUCCESS=true
              break
            else
              echo "âš ï¸ DMG creation attempt $attempt failed, cleaning up..."
              rm -f tinyMediaManager.dmg
              # Force cleanup any stuck processes
              sudo pkill -f hdiutil 2>/dev/null || true
              sleep 5
            fi
          done

          if [[ "$DMG_SUCCESS" != "true" ]]; then
            echo "âŒ Professional DMG creation failed after 3 attempts, falling back to standard DMG"
            # Final cleanup
            rm -f tinyMediaManager.dmg
            sudo diskutil list | grep tinyMediaManager | awk '{print $1}' | xargs -I {} sudo diskutil unmount {} 2>/dev/null || true
            sudo pkill -f hdiutil 2>/dev/null || true
            sleep 5

            # Use simple hdiutil create
            hdiutil create -volname "tinyMediaManager" \
              -srcfolder tinyMediaManager \
              -ov -format UDZO \
              tinyMediaManager.dmg
          fi
        else
          echo "ğŸ“¦ Creating standard DMG (GitLab tools not found)..."
          # Clean up any existing DMG and mounted volumes with retry
          for i in {1..5}; do
            if hdiutil detach /Volumes/tinyMediaManager 2>/dev/null; then
              echo "âœ… Unmounted existing volume (attempt $i)"
              break
            fi
            echo "â³ Waiting for volume to unmount (attempt $i/5)..."
            sleep 3
          done

          rm -f tinyMediaManager.dmg
          sudo diskutil list | grep tinyMediaManager | awk '{print $1}' | xargs -I {} sudo diskutil unmount {} 2>/dev/null || true
          sleep 5

          # Create standard DMG with timeout and retry
          for attempt in {1..3}; do
            echo "ğŸ”„ Standard DMG creation attempt $attempt/3..."
            if hdiutil create -volname "tinyMediaManager" \
              -srcfolder tinyMediaManager \
              -ov -format UDZO \
              tinyMediaManager.dmg; then
              echo "âœ… Standard DMG created successfully on attempt $attempt"
              break
            else
              echo "âš ï¸ Standard DMG creation attempt $attempt failed"
              rm -f tinyMediaManager.dmg
              sudo pkill -f hdiutil 2>/dev/null || true
              sleep 5
            fi
          done
        fi

        # Verify DMG was created successfully
        if [[ ! -f "tinyMediaManager.dmg" ]]; then
          echo "âŒ Error: DMG file was not created"
          exit 1
        fi

        # Copy unsigned DMG to dist (with clear naming) and verify
        DMG_NAME="tinyMediaManager-$VERSION-${{ matrix.platform.assembly }}-unsigned.dmg"
        if ! ditto tinyMediaManager.dmg "../dist/$DMG_NAME"; then
          echo "âŒ Error: Failed to copy DMG to dist directory"
          exit 1
        fi

        # Verify final DMG exists and get size
        if [[ -f "../dist/$DMG_NAME" ]]; then
          DMG_SIZE=$(ls -lh "../dist/$DMG_NAME" | awk '{print $5}')
          echo "âœ… Created professional unsigned DMG: $DMG_NAME ($DMG_SIZE)"
          echo "ğŸ¨ DMG includes professional layout and background (if available)"
          echo "âš ï¸  Users must manually allow this app in macOS Security & Privacy settings"
          echo "ğŸ’¡ Quick fix: xattr -dr com.apple.quarantine tinyMediaManager.app"
        else
          echo "âŒ Error: Final DMG verification failed"
          exit 1
        fi

        # Cleanup
        cd ..
        rm -rf macos_dmg_${{ matrix.platform.assembly }}
        echo "ğŸ§¹ Cleanup completed"
      shell: bash

    - name: Upload platform artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tinymediamanager-${{ matrix.platform.artifact-name }}-${{ github.sha }}
        path: |
          dist/*.zip
          dist/*.tar.bz2
          dist/*.dmg
          dist/*.sha256
        retention-days: 30

    - name: Upload Docker build artifacts
      if: matrix.platform.assembly == 'linux-amd64' || matrix.platform.assembly == 'linux-arm64'
      uses: actions/upload-artifact@v4
      with:
        name: tinyMediaManager-${{ matrix.platform.artifact-name }}
        path: |
          dist/tinyMediaManager-*-${{ matrix.platform.artifact-name }}.*
        retention-days: 30

  # åˆ›å»º GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-and-test, build-platforms]
    if: |
      always() && (
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release' && github.event.inputs.create_release == 'true')
      )
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Wait for platform builds
      run: |
        echo "â³ ç­‰å¾…æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆ..."
        sleep 30

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒèµ„äº§..."
        mkdir -p release-assets
        
        # æ˜¾ç¤ºæ‰€æœ‰ä¸‹è½½çš„artifacts
        echo "ğŸ“ å‘ç°çš„æ„å»ºäº§ç‰©:"
        find artifacts -type f \( -name "*.zip" -o -name "*.tar.bz2" -o -name "*.dmg" -o -name "*.sha256" \) | head -20
        
        # å¤åˆ¶å¹³å°æ„å»ºäº§ç‰©åˆ°å‘å¸ƒç›®å½•ï¼ˆæ’é™¤åŸå§‹JARæ–‡ä»¶ï¼‰
        find artifacts -name "*.zip" -exec cp {} release-assets/ \; 2>/dev/null || true
        find artifacts -name "*.tar.bz2" -exec cp {} release-assets/ \; 2>/dev/null || true
        find artifacts -name "*.dmg" -exec cp {} release-assets/ \; 2>/dev/null || true
        find artifacts -name "*.sha256" -exec cp {} release-assets/ \; 2>/dev/null || true
        
        # æ’é™¤åŸå§‹JARæ–‡ä»¶ï¼Œåªä¿ç•™å¹³å°ç‰¹å®šçš„æ„å»ºäº§ç‰©

        # é‡å‘½åæ–‡ä»¶ä»¥ä¾¿æ›´å¥½è¯†åˆ«
        cd release-assets
        for file in *; do
          if [[ -f "$file" ]]; then
            # ç§»é™¤é‡å¤åç¼€å¹¶æ ‡å‡†åŒ–å‘½å
            new_name=$(echo "$file" | sed 's/tinymediamanager-/tinyMediaManager-/g' | sed 's/--/-/g')
            if [[ "$file" != "$new_name" ]]; then
              mv "$file" "$new_name"
            fi
          fi
        done
        cd ..

        echo "âœ… å‘å¸ƒèµ„äº§å‡†å¤‡å®Œæˆ:"
        ls -la release-assets/
        
        # è®¡ç®—æ€»å¤§å°
        TOTAL_SIZE=$(du -sh release-assets/ | cut -f1)
        echo "ğŸ“Š æ€»å‘å¸ƒå¤§å°: $TOTAL_SIZE"

    - name: Extract version and tag info
      id: release-info
      run: |
        # æå–ç‰ˆæœ¬ä¿¡æ¯
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"
        else
          # ä»æ„å»ºäº§ç‰©ä¸­è·å–ç‰ˆæœ¬ä¿¡æ¯
          JAR_FILE=$(find artifacts -name "*.jar" | head -1)
          if [[ -n "$JAR_FILE" ]]; then
            VERSION=$(echo "$JAR_FILE" | sed 's/.*tinyMediaManager-\(.*\)\.jar/\1/')
          else
            VERSION="$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          fi
          TAG_NAME="v${VERSION}"
        fi
        
        echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ å‘å¸ƒç‰ˆæœ¬: $VERSION"
        echo "ğŸ·ï¸  Tagåç§°: $TAG_NAME"

    - name: Generate enhanced release notes
      id: release-notes
      run: |
        echo "ğŸ“ ç”Ÿæˆå¢å¼ºç‰ˆå‘å¸ƒè¯´æ˜..."
        
        TAG_NAME="${{ steps.release-info.outputs.tag }}"
        VERSION="${{ steps.release-info.outputs.version }}"
        
        # åˆ›å»ºè¯¦ç»†çš„å‘å¸ƒè¯´æ˜
        echo "# tinyMediaManager $VERSION" > release-notes.md
        echo "" >> release-notes.md
        echo "ğŸ‰ æˆ‘ä»¬å¾ˆé«˜å…´å‘å¸ƒ tinyMediaManager $VERSIONï¼" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ğŸ“¥ ä¸‹è½½" >> release-notes.md
        echo "" >> release-notes.md
        echo "### å¹³å°ç‰ˆæœ¬" >> release-notes.md
        echo "- **Windows x64**: tinyMediaManager-$VERSION-windows-amd64.zip" >> release-notes.md
        echo "- **Linux x64**: tinyMediaManager-$VERSION-linux-amd64.tar.bz2" >> release-notes.md
        echo "- **Linux ARM64**: tinyMediaManager-$VERSION-linux-arm64.tar.bz2" >> release-notes.md
        echo "- **macOS x64**: tinyMediaManager-$VERSION-macos-x86_64.dmg" >> release-notes.md
        echo "- **macOS ARM64**: tinyMediaManager-$VERSION-macos-aarch64.dmg" >> release-notes.md
        echo "" >> release-notes.md
        echo "" >> release-notes.md
        echo "## âš ï¸ macOSç”¨æˆ·æ³¨æ„" >> release-notes.md
        echo "macOSç‰ˆæœ¬ä¸ºæœªç­¾åç‰ˆæœ¬ï¼Œé¦–æ¬¡è¿è¡Œæ—¶éœ€è¦ï¼š" >> release-notes.md
        echo "1. åŒå‡»éšé™„çš„ \"Fix_macOS_Security.command\"" >> release-notes.md
        echo "2. æˆ–å³é”®é€‰æ‹© \"æ‰“å¼€\" å¹¶ç¡®è®¤å®‰å…¨è­¦å‘Š" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ğŸš€ å¿«é€Ÿå¼€å§‹" >> release-notes.md
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…" >> release-notes.md
        echo "2. è§£å‹/å®‰è£…åˆ°æ‚¨é€‰æ‹©çš„ç›®å½•" >> release-notes.md
        echo "3. è¿è¡Œ tinyMediaManager" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ğŸ”§ ç³»ç»Ÿè¦æ±‚" >> release-notes.md
        echo "- **Java**: 17æˆ–æ›´é«˜ç‰ˆæœ¬" >> release-notes.md
        echo "- **å†…å­˜**: å»ºè®®4GBä»¥ä¸Š" >> release-notes.md
        echo "- **å­˜å‚¨**: æ ¹æ®åª’ä½“åº“å¤§å°é¢„ç•™ç©ºé—´" >> release-notes.md
        echo "" >> release-notes.md
        echo "---" >> release-notes.md
        echo "*å‘å¸ƒäº: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> release-notes.md
        echo "*GitHub Actionsæ„å»º: #${{ github.run_number }}*" >> release-notes.md

        echo "release-notes<<EOF" >> $GITHUB_OUTPUT
        cat release-notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.release-info.outputs.tag }}
        name: tinyMediaManager ${{ steps.release-info.outputs.version }}
        body: ${{ steps.release-notes.outputs.release-notes }}
        files: release-assets/*
        draft: false
        prerelease: ${{ contains(steps.release-info.outputs.tag, 'beta') || contains(steps.release-info.outputs.tag, 'alpha') || contains(steps.release-info.outputs.tag, 'rc') }}
        generate_release_notes: false
        append_body: false

  # æ„å»ºçŠ¶æ€é€šçŸ¥
  notify-status:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: always()

    steps:
    - name: Determine overall status
      id: status
      run: |
        if [[ "${{ needs.build-and-test.result }}" == "success" ]]; then
          if [[ "${{ needs.build-platforms.result }}" == "success" || "${{ needs.build-platforms.result }}" == "skipped" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… æ„å»ºæˆåŠŸå®Œæˆ" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ åŸºç¡€æ„å»ºæˆåŠŸï¼Œä½†å¹³å°æ„å»ºå¤±è´¥" >> $GITHUB_OUTPUT
          fi
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ æ„å»ºå¤±è´¥" >> $GITHUB_OUTPUT
        fi

    - name: Print build summary
      run: |
        echo "ğŸ—ï¸ æ„å»ºæ‘˜è¦"
        echo "=============="
        echo "çŠ¶æ€: ${{ steps.status.outputs.message }}"
        echo "åŸºç¡€æ„å»º: ${{ needs.build-and-test.result }}"
        echo "å¹³å°æ„å»º: ${{ needs.build-platforms.result }}"
        echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        echo "åˆ†æ”¯/æ ‡ç­¾: ${{ github.ref }}"
