name: Multi-Platform CI/CD Pipeline

on:
  push:
    branches: [ devel, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ devel, main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - release
        - dist

permissions:
  contents: write
  packages: write
  actions: read

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx4096m -Xms2048m -XX:+UseG1GC -XX:MaxMetaspaceSize=512m'
  JAVA_TOOL_OPTIONS: '-Dfile.encoding=UTF-8'
  BUILD_TIMEOUT: 90

jobs:
  # åŸºç¡€æ„å»ºå’Œæµ‹è¯•ä½œä¸š (ç®€åŒ–ç‰ˆ)
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        server-id: github-maven
        server-username: GITHUB_ACTOR
        server-password: GITHUB_TOKEN

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Extract version
      id: version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ Project version: $VERSION"

    - name: Check if should release
      id: check-release
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "ğŸš€ This is a release build"
        elif [[ "${{ github.event.inputs.build_type }}" == "release" || "${{ github.event.inputs.build_type }}" == "dist" ]]; then
          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "ğŸš€ Manual release build requested"
        else
          echo "should-release=false" >> $GITHUB_OUTPUT
          echo "ğŸ”¨ This is a development build"
        fi

    - name: Skip tests for faster build
      run: |
        echo "âš¡ Skipping tests for faster build..."

    - name: Build JAR
      run: |
        echo "ğŸ”¨ Building JAR..."
        mvn clean package --batch-mode -DskipTests=true -Dmaven.test.skip=true -DskipSign=true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload base JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tinymediamanager-jar-${{ steps.version.outputs.version }}
        path: target/*.jar
        retention-days: 30



  # å¤šå¹³å°æ„å»ºä½œä¸š (ç®€åŒ–ç‰ˆ)
  build-platforms:
    name: Build for ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    needs: build-and-test
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/devel'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: "Windows x64"
            os: windows-latest
            assembly: windows-x64
            artifact-name: windows-x64
            native-path: native/windows
          - name: "Linux x64"
            os: ubuntu-latest
            assembly: linux-x64
            artifact-name: linux-x64
            native-path: native/linux
          - name: "Linux ARM64"
            os: ubuntu-latest
            assembly: linux-arm64
            artifact-name: linux-arm64
            native-path: native/arm
          - name: "macOS x64"
            os: macos-13
            assembly: macos-x64
            artifact-name: macos-x64
            native-path: native/mac
          - name: "macOS ARM64"
            os: macos-latest
            assembly: macos-aarch64
            artifact-name: macos-aarch64
            native-path: native/mac

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        server-id: github-maven
        server-username: GITHUB_ACTOR
        server-password: GITHUB_TOKEN

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Verify native libraries
      run: |
        echo "ğŸ” Checking native libraries for ${{ matrix.platform.name }}..."
        if [ -d "${{ matrix.platform.native-path }}" ]; then
          echo "âœ… Native libraries found:"
          ls -la ${{ matrix.platform.native-path }}/
        else
          echo "âš ï¸ No native libraries found for this platform"
        fi
      shell: bash

    - name: Build platform distribution
      run: |
        echo "ğŸ—ï¸ Building distribution for ${{ matrix.platform.name }}..."
        mvn clean package -Pdist --batch-mode -DskipTests=true -Dmaven.test.skip=true -DskipSign=true -Dmaven.javadoc.skip=true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: bash

    - name: Create platform package
      run: |
        echo "ğŸ“¦ Creating platform package for ${{ matrix.platform.name }}..."
        echo "ğŸ” Looking for files matching pattern: tinyMediaManager-*-${{ matrix.platform.assembly }}.*"
        ls -la dist/

        # Check for any file matching the platform pattern
        if ls dist/tinyMediaManager-*-${{ matrix.platform.assembly }}.* 1> /dev/null 2>&1; then
          echo "âœ… Package created successfully for ${{ matrix.platform.name }}"
          echo "ğŸ“ Found files:"
          ls -la dist/tinyMediaManager-*-${{ matrix.platform.assembly }}.*
        else
          echo "âŒ No package found for ${{ matrix.platform.assembly }}"
          echo "ğŸ“ Available files in dist/:"
          ls -la dist/ || echo "No dist directory found"
          exit 1
        fi
      shell: bash

    - name: Upload platform artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tinymediamanager-${{ matrix.platform.artifact-name }}-${{ needs.build-and-test.outputs.version }}
        path: |
          dist/*.zip
          dist/*.tar.bz2
          dist/*.sha256
        retention-days: 30

  # åˆ›å»º GitHub Release (æš‚æ—¶ç¦ç”¨)
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        echo "ğŸ“¦ Preparing release assets..."
        mkdir -p release-assets

        # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©åˆ°å‘å¸ƒç›®å½•
        find artifacts -name "*.zip" -exec cp {} release-assets/ \;
        find artifacts -name "*.tar.bz2" -exec cp {} release-assets/ \;
        find artifacts -name "*.sha256" -exec cp {} release-assets/ \;
        find artifacts -name "*.jar" -exec cp {} release-assets/ \;

        echo "âœ… Release assets prepared:"
        ls -la release-assets/

    - name: Generate release notes
      id: release-notes
      run: |
        echo "ğŸ“ Generating release notes..."

        # æå–ç‰ˆæœ¬å·
        VERSION="${{ needs.build-and-test.outputs.version }}"
        TAG_NAME="${GITHUB_REF#refs/tags/}"

        # ç”Ÿæˆå‘å¸ƒè¯´æ˜
        cat > release-notes.md << EOF
        # tinyMediaManager ${TAG_NAME}

        ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ

        è¿™æ˜¯ tinyMediaManager çš„ ${TAG_NAME} ç‰ˆæœ¬ï¼Œæ”¯æŒå¤šä¸ªå¹³å°ã€‚

        ## ğŸ“¦ ä¸‹è½½

        ### Windows
        - **Windows x64**: \`tinyMediaManager-${VERSION}-windows-amd64.zip\`

        ### Linux
        - **Linux x64**: \`tinyMediaManager-${VERSION}-linux-x64.tar.bz2\`
        - **Linux ARM64**: \`tinyMediaManager-${VERSION}-linux-aarch64.tar.bz2\`

        ### macOS
        - **macOS Intel**: \`tinyMediaManager-${VERSION}-macos-x64.tar.bz2\`
        - **macOS Apple Silicon**: \`tinyMediaManager-${VERSION}-macos-aarch64.tar.bz2\`

        ## ğŸ” æ ¡éªŒå’Œ
        æ¯ä¸ªä¸‹è½½åŒ…éƒ½æä¾›äº† SHA256 æ ¡éªŒå’Œæ–‡ä»¶ï¼Œè¯·åœ¨å®‰è£…å‰éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ã€‚

        ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
        - Java 17 æˆ–æ›´é«˜ç‰ˆæœ¬
        - æ”¯æŒçš„æ“ä½œç³»ç»Ÿï¼šWindows 10+, macOS 10.14+, Linux (å„ä¸»è¦å‘è¡Œç‰ˆ)

        ## ğŸ› é—®é¢˜åé¦ˆ
        å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/jonntd/tinymediamanager/issues) ä¸­æŠ¥å‘Šã€‚
        EOF

        echo "release-notes<<EOF" >> $GITHUB_OUTPUT
        cat release-notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: tinyMediaManager ${{ github.ref_name }}
        body: ${{ steps.release-notes.outputs.release-notes }}
        files: release-assets/*
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        generate_release_notes: true

  # æ„å»ºçŠ¶æ€é€šçŸ¥
  notify-status:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: always()

    steps:
    - name: Determine overall status
      id: status
      run: |
        if [[ "${{ needs.build-and-test.result }}" == "success" ]]; then
          if [[ "${{ needs.build-platforms.result }}" == "success" || "${{ needs.build-platforms.result }}" == "skipped" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… æ„å»ºæˆåŠŸå®Œæˆ" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ åŸºç¡€æ„å»ºæˆåŠŸï¼Œä½†å¹³å°æ„å»ºå¤±è´¥" >> $GITHUB_OUTPUT
          fi
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ æ„å»ºå¤±è´¥" >> $GITHUB_OUTPUT
        fi

    - name: Print build summary
      run: |
        echo "ğŸ—ï¸ æ„å»ºæ‘˜è¦"
        echo "=============="
        echo "çŠ¶æ€: ${{ steps.status.outputs.message }}"
        echo "åŸºç¡€æ„å»º: ${{ needs.build-and-test.result }}"
        echo "å¹³å°æ„å»º: ${{ needs.build-platforms.result }}"
        echo "ç‰ˆæœ¬: ${{ needs.build-and-test.outputs.version }}"
        echo "åº”è¯¥å‘å¸ƒ: ${{ needs.build-and-test.outputs.should-release }}"
