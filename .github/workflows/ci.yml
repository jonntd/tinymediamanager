name: Multi-Platform CI/CD Pipeline

on:
  push:
    branches: [ devel, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ devel, main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - release
        - dist

permissions:
  contents: write
  packages: write
  actions: read

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx4096m -Xms2048m -XX:+UseG1GC -XX:MaxMetaspaceSize=512m'
  JAVA_TOOL_OPTIONS: '-Dfile.encoding=UTF-8'
  BUILD_TIMEOUT: 90

jobs:
  # åŸºç¡€æ„å»ºå’Œæµ‹è¯•ä½œä¸š (ç®€åŒ–ç‰ˆ)
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        server-id: github-maven
        server-username: GITHUB_ACTOR
        server-password: GITHUB_TOKEN

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Extract version
      id: version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ Project version: $VERSION"

    - name: Check if should release
      id: check-release
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "ğŸš€ This is a release build"
        elif [[ "${{ github.event.inputs.build_type }}" == "release" || "${{ github.event.inputs.build_type }}" == "dist" ]]; then
          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "ğŸš€ Manual release build requested"
        else
          echo "should-release=false" >> $GITHUB_OUTPUT
          echo "ğŸ”¨ This is a development build"
        fi

    - name: Skip tests for faster build
      run: |
        echo "âš¡ Skipping tests for faster build..."

    - name: Build JAR
      run: |
        echo "ğŸ”¨ Building JAR with performance optimizations..."
        mvn clean package --batch-mode -T 2 -DskipTests=true -Dmaven.test.skip=true -DskipSign=true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC -XX:+UseStringDeduplication"

    - name: Upload base JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tinymediamanager-jar-${{ steps.version.outputs.version }}
        path: target/*.jar
        retention-days: 30



  # å¤šå¹³å°æ„å»ºä½œä¸š (ç®€åŒ–ç‰ˆ)
  build-platforms:
    name: Build for ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    needs: build-and-test
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/devel'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: "Windows x64"
            os: windows-latest
            assembly: windows-amd64
            artifact-name: windows-amd64
            native-path: native/windows
          - name: "Linux x64"
            os: ubuntu-latest
            assembly: linux-amd64
            artifact-name: linux-amd64
            native-path: native/linux
          - name: "Linux ARM64"
            os: ubuntu-latest
            assembly: linux-arm64
            artifact-name: linux-arm64
            native-path: native/arm
          - name: "macOS x64"
            os: macos-13
            assembly: macos-x86_64
            artifact-name: macos-x86_64
            native-path: native/mac
          - name: "macOS ARM64"
            os: macos-latest
            assembly: macos-aarch64
            artifact-name: macos-aarch64
            native-path: native/mac

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        server-id: github-maven
        server-username: GITHUB_ACTOR
        server-password: GITHUB_TOKEN

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Verify native libraries
      run: |
        echo "ğŸ” Checking native libraries for ${{ matrix.platform.name }}..."
        if [ -d "${{ matrix.platform.native-path }}" ]; then
          echo "âœ… Native libraries found:"
          ls -la ${{ matrix.platform.native-path }}/
        else
          echo "âš ï¸ No native libraries found for this platform"
        fi
      shell: bash

    - name: Build platform distribution
      run: |
        echo "ğŸ—ï¸ Building distribution for ${{ matrix.platform.name }} with optimizations..."
        echo "ğŸ“‹ Using Maven profile: ${{ matrix.platform.assembly }}"
        echo "âš¡ Performance: 2 threads, optimized JVM, incremental build"
        mvn package -Pdist,${{ matrix.platform.assembly }} --batch-mode -T 2 -DskipTests=true -Dmaven.test.skip=true -DskipSign=true -Dmaven.javadoc.skip=true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MAVEN_OPTS: "-Xmx3g -XX:+UseG1GC -XX:+UseStringDeduplication -XX:+UseCompressedOops"
      shell: bash

    - name: Create platform package
      run: |
        echo "ğŸ“¦ Creating platform package for ${{ matrix.platform.name }}..."
        echo "ğŸ” Looking for files matching pattern: tinyMediaManager-*-${{ matrix.platform.assembly }}.*"
        ls -la dist/

        # Check for any file matching the platform pattern
        if ls dist/tinyMediaManager-*-${{ matrix.platform.assembly }}.* 1> /dev/null 2>&1; then
          echo "âœ… Package created successfully for ${{ matrix.platform.name }}"
          echo "ğŸ“ Found files:"
          ls -la dist/tinyMediaManager-*-${{ matrix.platform.assembly }}.*
        else
          echo "âŒ No package found for ${{ matrix.platform.assembly }}"
          echo "ğŸ“ Available files in dist/:"
          ls -la dist/ || echo "No dist directory found"
          exit 1
        fi
      shell: bash

    - name: Create professional macOS DMG (GitLab-style, unsigned)
      if: startsWith(matrix.platform.assembly, 'macos-')
      run: |
        set -e  # Exit on any error

        echo "ğŸ Creating professional macOS DMG for ${{ matrix.platform.name }}..."
        echo "ğŸ“‹ Using GitLab's DMG creation method (without signing)"
        echo "âš ï¸  Note: This DMG will be unsigned (no Apple Developer account)"
        echo "ğŸ“‹ Users will need to manually allow the app: xattr -dr com.apple.quarantine tinyMediaManager.app"

        # Create temporary directory for DMG creation (GitLab style)
        mkdir -p macos_dmg_${{ matrix.platform.assembly }}
        cd macos_dmg_${{ matrix.platform.assembly }}

        # Extract the ZIP file (same as GitLab method) with error checking
        ZIP_FILE="../dist/tinyMediaManager-*-${{ matrix.platform.assembly }}.zip"
        if ! ls $ZIP_FILE 1> /dev/null 2>&1; then
          echo "âŒ Error: No ZIP file found matching pattern: $ZIP_FILE"
          exit 1
        fi

        echo "ğŸ“¦ Extracting ZIP file..."
        if ! unzip -q -X $ZIP_FILE -d tinyMediaManager; then
          echo "âŒ Error: Failed to extract ZIP file"
          exit 1
        fi

        # Verify app bundle exists
        if [[ ! -d "tinyMediaManager/tinyMediaManager.app" ]]; then
          echo "âŒ Error: tinyMediaManager.app not found in extracted files"
          echo "ğŸ“ Available files:"
          ls -la tinyMediaManager/ || true
          exit 1
        fi

        # Get version (same as GitLab method) with error checking
        VERSION_FILE="tinyMediaManager/tinyMediaManager.app/Contents/Resources/Java/version"
        if [[ ! -f "$VERSION_FILE" ]]; then
          echo "âŒ Error: Version file not found: $VERSION_FILE"
          exit 1
        fi

        VERSION=$(grep 'human.version' "$VERSION_FILE" | cut -d'=' -f2)
        if [[ -z "$VERSION" ]]; then
          echo "âŒ Error: Could not extract version from $VERSION_FILE"
          exit 1
        fi
        echo "ğŸ“¦ Version: $VERSION"

        # Create .userdir file (same as GitLab method)
        touch tinyMediaManager/tinyMediaManager.app/Contents/Resources/Java/.userdir

        # Fix critical macOS app permissions (GitLab does this automatically)
        echo "ğŸ”§ Fixing macOS app permissions and structure..."

        # Ensure the main executable has correct permissions
        MAIN_EXECUTABLE="tinyMediaManager/tinyMediaManager.app/Contents/MacOS/tinyMediaManager"
        if [[ -f "$MAIN_EXECUTABLE" ]]; then
          chmod +x "$MAIN_EXECUTABLE"
          echo "âœ… Set executable permissions for main app"
        else
          echo "âŒ Warning: Main executable not found at $MAIN_EXECUTABLE"
          echo "ğŸ“ Available files in MacOS directory:"
          ls -la "tinyMediaManager/tinyMediaManager.app/Contents/MacOS/" || echo "MacOS directory not found"
        fi

        # Ensure Info.plist exists and is readable
        INFO_PLIST="tinyMediaManager/tinyMediaManager.app/Contents/Info.plist"
        if [[ -f "$INFO_PLIST" ]]; then
          chmod 644 "$INFO_PLIST"
          echo "âœ… Set correct permissions for Info.plist"
          echo "ğŸ“‹ Info.plist CFBundleExecutable: $(plutil -extract CFBundleExecutable raw "$INFO_PLIST" 2>/dev/null || echo 'Not found')"
        else
          echo "âŒ Warning: Info.plist not found at $INFO_PLIST"
        fi

        # Set correct permissions for the entire app bundle
        chmod -R u+rw,go+r "tinyMediaManager/tinyMediaManager.app"
        find "tinyMediaManager/tinyMediaManager.app" -type d -exec chmod 755 {} \;
        echo "âœ… Set correct permissions for entire app bundle"

        # Create comprehensive auto-fix script for users using printf
        printf '#!/bin/bash\nset -e\n\necho "ğŸ tinyMediaManager macOS æƒé™ä¿®å¤å·¥å…·"\necho "========================================"\necho ""\necho "æ­¤è„šæœ¬å°†ä¿®å¤ macOS å¯¹æœªç­¾ååº”ç”¨çš„å¸¸è§é—®é¢˜ï¼š"\necho "- ç§»é™¤éš”ç¦»å±æ€§ (quarantine)"\necho "- ä¿®å¤æ–‡ä»¶æƒé™"\necho "- éªŒè¯åº”ç”¨ç¨‹åºç»“æ„"\necho ""\nread -p "æŒ‰å›è½¦é”®ç»§ç»­ï¼Œæˆ–æŒ‰ Ctrl+C å–æ¶ˆ..."\necho ""\n\n# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•\nSCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"\nAPP_PATH="$SCRIPT_DIR/tinyMediaManager.app"\n\n# å¦‚æœåœ¨åŒä¸€ç›®å½•æ‰¾ä¸åˆ°ï¼Œå°è¯•å¸¸è§ä½ç½®\nif [ ! -d "$APP_PATH" ]; then\n    echo "ï¿½ åœ¨å½“å‰ç›®å½•æœªæ‰¾åˆ° tinyMediaManager.appï¼Œæ­£åœ¨æœç´¢..."\n    \n    # æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å¤¹\n    if [ -d "$HOME/Downloads/tinyMediaManager.app" ]; then\n        APP_PATH="$HOME/Downloads/tinyMediaManager.app"\n        echo "âœ… åœ¨ä¸‹è½½æ–‡ä»¶å¤¹æ‰¾åˆ°åº”ç”¨ç¨‹åº"\n    # æ£€æŸ¥æ¡Œé¢\n    elif [ -d "$HOME/Desktop/tinyMediaManager.app" ]; then\n        APP_PATH="$HOME/Desktop/tinyMediaManager.app"\n        echo "âœ… åœ¨æ¡Œé¢æ‰¾åˆ°åº”ç”¨ç¨‹åº"\n    # æ£€æŸ¥åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹\n    elif [ -d "/Applications/tinyMediaManager.app" ]; then\n        APP_PATH="/Applications/tinyMediaManager.app"\n        echo "âœ… åœ¨åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹æ‰¾åˆ°åº”ç”¨ç¨‹åº"\n    else\n        echo "âŒ æœªæ‰¾åˆ° tinyMediaManager.app"\n        echo ""\n        echo "è¯·ç¡®ä¿ tinyMediaManager.app ä½äºä»¥ä¸‹ä½ç½®ä¹‹ä¸€ï¼š"\n        echo "- ä¸æ­¤è„šæœ¬ç›¸åŒçš„æ–‡ä»¶å¤¹"\n        echo "- ä¸‹è½½æ–‡ä»¶å¤¹ (~/Downloads/)"\n        echo "- æ¡Œé¢ (~/Desktop/)"\n        echo "- åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ (/Applications/)"\n        echo ""\n        read -p "æŒ‰å›è½¦é”®å…³é—­æ­¤çª—å£..."\n        exit 1\n    fi\nfi\n\necho "ğŸ“ åº”ç”¨ç¨‹åºè·¯å¾„: $APP_PATH"\necho ""\n\nif [ -d "$APP_PATH" ]; then\n    echo "ğŸ”§ æ­¥éª¤ 1: ç§»é™¤éš”ç¦»å±æ€§..."\n    if xattr -dr com.apple.quarantine "$APP_PATH" 2>/dev/null; then\n        echo "âœ… éš”ç¦»å±æ€§ç§»é™¤æˆåŠŸ"\n    else\n        echo "âš ï¸  éš”ç¦»å±æ€§ç§»é™¤å¤±è´¥ (å¯èƒ½ä¸éœ€è¦)"\n    fi\n    \n    echo ""\n    echo "ğŸ”§ æ­¥éª¤ 2: ä¿®å¤æ–‡ä»¶æƒé™..."\n    \n    # ä¿®å¤ä¸»æ‰§è¡Œæ–‡ä»¶æƒé™\n    MAIN_EXEC="$APP_PATH/Contents/MacOS/tinyMediaManager"\n    if [ -f "$MAIN_EXEC" ]; then\n        chmod +x "$MAIN_EXEC"\n        echo "âœ… ä¸»æ‰§è¡Œæ–‡ä»¶æƒé™å·²ä¿®å¤"\n    else\n        echo "âŒ æœªæ‰¾åˆ°ä¸»æ‰§è¡Œæ–‡ä»¶: $MAIN_EXEC"\n    fi\n    \n    # ä¿®å¤ Info.plist æƒé™\n    INFO_PLIST="$APP_PATH/Contents/Info.plist"\n    if [ -f "$INFO_PLIST" ]; then\n        chmod 644 "$INFO_PLIST"\n        echo "âœ… Info.plist æƒé™å·²ä¿®å¤"\n    else\n        echo "âŒ æœªæ‰¾åˆ° Info.plist: $INFO_PLIST"\n    fi\n    \n    # ä¿®å¤æ•´ä¸ªåº”ç”¨åŒ…æƒé™\n    chmod -R u+rw,go+r "$APP_PATH"\n    find "$APP_PATH" -type d -exec chmod 755 {} \\;\n    echo "âœ… åº”ç”¨åŒ…æƒé™å·²ä¿®å¤"\n    \n    echo ""\n    echo "ğŸ”§ æ­¥éª¤ 3: éªŒè¯åº”ç”¨ç¨‹åºç»“æ„..."\n    \n    # æ£€æŸ¥å…³é”®æ–‡ä»¶\n    if [ -f "$MAIN_EXEC" ] && [ -f "$INFO_PLIST" ]; then\n        echo "âœ… åº”ç”¨ç¨‹åºç»“æ„æ­£å¸¸"\n        echo ""\n        echo "ğŸ‰ æ‰€æœ‰ä¿®å¤å·²æˆåŠŸå®Œæˆï¼"\n        echo ""\n        echo "ç°åœ¨ä½ å¯ä»¥åŒå‡» tinyMediaManager.app æ¥å¯åŠ¨å®ƒã€‚"\n        echo ""\n        echo "å¦‚æœä»ç„¶é‡åˆ°é”™è¯¯ï¼Œè¯·å°è¯•ï¼š"\n        echo "1. å³é”®ç‚¹å‡» tinyMediaManager.app å¹¶é€‰æ‹© '\''æ‰“å¼€'\''"\n        echo "2. å‰å¾€ ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ > é€šç”¨"\n        echo "3. ç‚¹å‡» '\''ä»è¦æ‰“å¼€'\'' (å¦‚æœå‡ºç°æç¤º)"\n        echo ""\n    else\n        echo "âŒ åº”ç”¨ç¨‹åºç»“æ„ä¼¼ä¹å·²æŸå"\n        echo "è¯·é‡æ–°ä¸‹è½½åº”ç”¨ç¨‹åº"\n        echo ""\n    fi\n    \n    read -p "æŒ‰å›è½¦é”®å…³é—­æ­¤çª—å£..."\nelse\n    echo "âŒ åœ¨æŒ‡å®šè·¯å¾„æœªæ‰¾åˆ° tinyMediaManager.app"\n    echo "è¯·ç¡®ä¿æ­¤è„šæœ¬ä¸ tinyMediaManager.app åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­"\n    echo ""\n    read -p "æŒ‰å›è½¦é”®å…³é—­æ­¤çª—å£..."\n    exit 1\nfi\n' > tinyMediaManager/Fix_macOS_Security.command

        # Make the script executable
        chmod +x tinyMediaManager/Fix_macOS_Security.command

        # Create a README for users using printf
        printf 'ğŸ tinyMediaManager for macOS (GitHub æ„å»ºç‰ˆæœ¬)\n==========================================\n\nâš ï¸  é‡è¦æç¤ºï¼šè¿™æ˜¯æ¥è‡ª GitHub Actions çš„æœªç­¾åæ„å»ºç‰ˆæœ¬ã€‚\nmacOS ä¼šåœ¨æ‚¨é¦–æ¬¡å°è¯•è¿è¡Œ tinyMediaManager.app æ—¶æ˜¾ç¤ºå®‰å…¨è­¦å‘Šã€‚\n\nğŸš€ å¿«é€Ÿä¿®å¤æ–¹æ³•ï¼ˆé€‰æ‹©å…¶ä¸­ä¸€ç§ï¼‰ï¼š\n\nâœ… æ–¹æ³• 1ï¼šåŒå‡» "Fix_macOS_Security.command" â­ æ¨è\n   - è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ä¿®å¤å®‰å…¨é—®é¢˜\n   - åªéœ€æŒ‰ç…§æç¤ºæ“ä½œå³å¯\n   - æ”¯æŒè‡ªåŠ¨æœç´¢åº”ç”¨ç¨‹åºä½ç½®\n\nâœ… æ–¹æ³• 2ï¼šå³é”®æ‰“å¼€\n   - å³é”®ç‚¹å‡» tinyMediaManager.app\n   - é€‰æ‹© "æ‰“å¼€"ï¼ˆä¸æ˜¯åŒå‡»ï¼‰\n   - åœ¨å®‰å…¨è­¦å‘Šä¸­ç‚¹å‡» "æ‰“å¼€"\n\nâœ… æ–¹æ³• 3ï¼šç»ˆç«¯å‘½ä»¤\n   - æ‰“å¼€ç»ˆç«¯ (Terminal)\n   - è¾“å…¥ï¼šxattr -dr com.apple.quarantine\n   - å°† tinyMediaManager.app æ‹–å…¥ç»ˆç«¯\n   - æŒ‰å›è½¦æ‰§è¡Œ\n\nâœ… æ–¹æ³• 4ï¼šç³»ç»Ÿè®¾ç½®\n   - å°è¯•æ‰“å¼€ tinyMediaManager.appï¼ˆä¼šå¤±è´¥ï¼‰\n   - å‰å¾€ ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ > é€šç”¨\n   - ç‚¹å‡» "ä»è¦æ‰“å¼€"ï¼ˆå¦‚æœå‡ºç°æç¤ºï¼‰\n\nğŸ¯ ä½¿ç”¨ä»»ä½•ä¸Šè¿°æ–¹æ³•åï¼ŒtinyMediaManager.app å°†æ­£å¸¸è¿è¡Œã€‚\n\nğŸ’¡ æç¤ºï¼šå¦‚æœæ‚¨ç»å¸¸ä½¿ç”¨ GitHub æ„å»ºçš„åº”ç”¨ï¼Œå»ºè®®ä½¿ç”¨æ–¹æ³• 1 çš„è‡ªåŠ¨ä¿®å¤è„šæœ¬ã€‚\n\nğŸ“ å¦‚éœ€æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼šhttps://github.com/jonntd/tinymediamanager\n\nğŸ”§ æ•…éšœæ’é™¤ï¼š\n- å¦‚æœä¿®å¤è„šæœ¬æ‰¾ä¸åˆ°åº”ç”¨ç¨‹åºï¼Œè¯·ç¡®ä¿å®ƒä»¬åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­\n- å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·å°è¯•é‡æ–°ä¸‹è½½æœ€æ–°ç‰ˆæœ¬\n- å¯¹äº macOS Ventura/Sonoma ç”¨æˆ·ï¼Œè¯·æŸ¥çœ‹ "ç³»ç»Ÿè®¾ç½®" è€Œä¸æ˜¯ "ç³»ç»Ÿåå¥½è®¾ç½®"\n' > tinyMediaManager/README_macOS.txt

        echo "ğŸ“¦ Creating professional DMG with GitLab styling..."

        # Copy DS_Store if available (for proper Finder layout)
        if [[ -f "../AppBundler/macos/DS_Store" ]]; then
          cp ../AppBundler/macos/DS_Store tinyMediaManager/.DS_Store
          echo "âœ… Applied Finder layout settings"
        fi

        # Copy auto-launch script if available
        if [[ -f "../AppBundler/macos/auto_launch.sh" ]]; then
          cp ../AppBundler/macos/auto_launch.sh tinyMediaManager/
          chmod +x tinyMediaManager/auto_launch.sh
          echo "âœ… Added auto-launch script"
        fi

        # Use GitLab's professional create-dmg tool if available
        if [[ -f "../AppBundler/macos/bin/create-dmg" && -f "../AppBundler/macos/background.png" ]]; then
          echo "ğŸ¨ Creating professional DMG with background and layout..."
          chmod +x ../AppBundler/macos/bin/create-dmg

          # Clean up any existing DMG and mounted volumes before creating
          rm -f tinyMediaManager.dmg
          hdiutil detach /Volumes/tinyMediaManager 2>/dev/null || true
          sleep 2

          # Build create-dmg arguments dynamically based on file existence
          DMG_ARGS=(
            --background ../AppBundler/macos/background.png
            --volname "tinyMediaManager"
            --window-pos 200 120
            --window-size 660 400
            --icon-size 100
            --app-drop-link 500 300
            --skip-jenkins
            --format UDBZ
          )

          # Add icon positioning for files that exist
          if [[ -d "tinyMediaManager/tinyMediaManager.app" ]]; then
            DMG_ARGS+=(--icon "tinyMediaManager.app" 160 180)
            DMG_ARGS+=(--hide-extension "tinyMediaManager.app")
            echo "âœ… Will position tinyMediaManager.app icon"
          fi

          # Position Fix App like a UI button (prominent position)
          if [[ -d "tinyMediaManager/Fix macOS Security.app" ]]; then
            DMG_ARGS+=(--icon "Fix macOS Security.app" 450 300)
            DMG_ARGS+=(--hide-extension "Fix macOS Security.app")
            echo "âœ… Will position Fix macOS Security.app as UI button (450, 300)"
          fi

          if [[ -f "tinyMediaManager/Fix_macOS_Security.command" ]]; then
            DMG_ARGS+=(--icon "Fix_macOS_Security.command" 320 300)
            DMG_ARGS+=(--hide-extension "Fix_macOS_Security.command")
            echo "âœ… Will position Fix_macOS_Security.command as backup option"
          fi

          if [[ -f "tinyMediaManager/README_macOS.txt" ]]; then
            DMG_ARGS+=(--icon "README_macOS.txt" 320 180)
            echo "âœ… Will position README_macOS.txt icon"
          fi

          # Create DMG with dynamic arguments
          ../AppBundler/macos/bin/create-dmg "${DMG_ARGS[@]}" tinyMediaManager.dmg tinyMediaManager

          if [[ $? -eq 0 ]]; then
            echo "âœ… Professional DMG created successfully"
          else
            echo "âŒ Professional DMG creation failed, falling back to standard DMG"
            # Clean up any existing DMG and mounted volumes
            rm -f tinyMediaManager.dmg
            hdiutil detach /Volumes/tinyMediaManager 2>/dev/null || true
            sleep 2
            hdiutil create -volname "tinyMediaManager" \
              -srcfolder tinyMediaManager \
              -ov -format UDZO \
              tinyMediaManager.dmg
          fi
        else
          echo "ğŸ“¦ Creating standard DMG (GitLab tools not found)..."
          # Clean up any existing DMG and mounted volumes
          rm -f tinyMediaManager.dmg
          hdiutil detach /Volumes/tinyMediaManager 2>/dev/null || true
          sleep 2
          hdiutil create -volname "tinyMediaManager" \
            -srcfolder tinyMediaManager \
            -ov -format UDZO \
            tinyMediaManager.dmg
        fi

        # Verify DMG was created successfully
        if [[ ! -f "tinyMediaManager.dmg" ]]; then
          echo "âŒ Error: DMG file was not created"
          exit 1
        fi

        # Copy unsigned DMG to dist (with clear naming) and verify
        DMG_NAME="tinyMediaManager-$VERSION-${{ matrix.platform.assembly }}-unsigned.dmg"
        if ! ditto tinyMediaManager.dmg "../dist/$DMG_NAME"; then
          echo "âŒ Error: Failed to copy DMG to dist directory"
          exit 1
        fi

        # Verify final DMG exists and get size
        if [[ -f "../dist/$DMG_NAME" ]]; then
          DMG_SIZE=$(ls -lh "../dist/$DMG_NAME" | awk '{print $5}')
          echo "âœ… Created professional unsigned DMG: $DMG_NAME ($DMG_SIZE)"
          echo "ğŸ¨ DMG includes professional layout and background (if available)"
          echo "âš ï¸  Users must manually allow this app in macOS Security & Privacy settings"
          echo "ğŸ’¡ Quick fix: xattr -dr com.apple.quarantine tinyMediaManager.app"
        else
          echo "âŒ Error: Final DMG verification failed"
          exit 1
        fi

        # Cleanup
        cd ..
        rm -rf macos_dmg_${{ matrix.platform.assembly }}
        echo "ğŸ§¹ Cleanup completed"
      shell: bash

    - name: Upload platform artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tinymediamanager-${{ matrix.platform.artifact-name }}-${{ needs.build-and-test.outputs.version }}
        path: |
          dist/*.zip
          dist/*.tar.bz2
          dist/*.dmg
          dist/*.sha256
        retention-days: 30

  # åˆ›å»º GitHub Release (æš‚æ—¶ç¦ç”¨)
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        echo "ğŸ“¦ Preparing release assets..."
        mkdir -p release-assets

        # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©åˆ°å‘å¸ƒç›®å½•
        find artifacts -name "*.zip" -exec cp {} release-assets/ \;
        find artifacts -name "*.tar.bz2" -exec cp {} release-assets/ \;
        find artifacts -name "*.sha256" -exec cp {} release-assets/ \;
        find artifacts -name "*.jar" -exec cp {} release-assets/ \;

        echo "âœ… Release assets prepared:"
        ls -la release-assets/

    - name: Generate release notes
      id: release-notes
      run: |
        echo "ğŸ“ Generating release notes..."

        # æå–ç‰ˆæœ¬å·
        VERSION="${{ needs.build-and-test.outputs.version }}"
        TAG_NAME="${GITHUB_REF#refs/tags/}"

        # ç”Ÿæˆç®€å•å‘å¸ƒè¯´æ˜
        echo "# tinyMediaManager ${TAG_NAME}" > release-notes.md
        echo "" >> release-notes.md
        echo "New release of tinyMediaManager ${TAG_NAME}" >> release-notes.md

        echo "release-notes<<EOF" >> $GITHUB_OUTPUT
        cat release-notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: tinyMediaManager ${{ github.ref_name }}
        body: ${{ steps.release-notes.outputs.release-notes }}
        files: release-assets/*
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        generate_release_notes: true

  # æ„å»ºçŠ¶æ€é€šçŸ¥
  notify-status:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: always()

    steps:
    - name: Determine overall status
      id: status
      run: |
        if [[ "${{ needs.build-and-test.result }}" == "success" ]]; then
          if [[ "${{ needs.build-platforms.result }}" == "success" || "${{ needs.build-platforms.result }}" == "skipped" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… æ„å»ºæˆåŠŸå®Œæˆ" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ åŸºç¡€æ„å»ºæˆåŠŸï¼Œä½†å¹³å°æ„å»ºå¤±è´¥" >> $GITHUB_OUTPUT
          fi
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ æ„å»ºå¤±è´¥" >> $GITHUB_OUTPUT
        fi

    - name: Print build summary
      run: |
        echo "ğŸ—ï¸ æ„å»ºæ‘˜è¦"
        echo "=============="
        echo "çŠ¶æ€: ${{ steps.status.outputs.message }}"
        echo "åŸºç¡€æ„å»º: ${{ needs.build-and-test.result }}"
        echo "å¹³å°æ„å»º: ${{ needs.build-platforms.result }}"
        echo "ç‰ˆæœ¬: ${{ needs.build-and-test.outputs.version }}"
        echo "åº”è¯¥å‘å¸ƒ: ${{ needs.build-and-test.outputs.should-release }}"
