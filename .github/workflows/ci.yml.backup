name: CI/CD Pipeline

on:
  push:
    branches: [ devel ]
    tags:
      - 'v*'
  pull_request:
    branches: [ devel ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - release

env:
  MAVEN_OPTS: -Dmaven.repo.local=${{ github.workspace }}/.m2/repository
  JAVA_VERSION: '17'

jobs:




  # æ„å»ºé˜¶æ®µ
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: Build application
      id: build
      continue-on-error: true
      run: |
        mvn clean package --batch-mode -P dist -DbuildNumber="${{ github.sha }}" -DskipSign=true -DskipTests=true -Dmaven.test.skip=true -Ddependency.copy.skip=true

    - name: Auto-fix build errors
      if: steps.build.outcome == 'failure'
      run: |
        echo "ğŸ”§ Build failed, attempting simple auto-fix..."
        echo "ğŸ“ Trying alternative build command..."
        mvn clean install --batch-mode -DskipTests=true -DskipSign=true -Ddependency.copy.skip=true
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.os }}
        path: |
          target/*.jar
          dist/
        retention-days: 30

    - name: Print download links
      run: |
        echo "ğŸ‰ Build completed for ${{ matrix.os }}!"
        echo "ğŸ“¦ Artifact name: build-${{ matrix.os }}"
        echo "ğŸ”— Download link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "ğŸ’¡ Go to Actions â†’ This run â†’ Artifacts section to download"

  # Dockeræ„å»º
  docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/devel'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-ubuntu-latest
        path: ./artifacts
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository_owner }}/tinymediamanager
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=devel
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: src/docker/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Print Docker image links
      run: |
        echo "ğŸ³ Docker image built and pushed successfully!"
        echo "ğŸ“¦ Image tags:"
        echo "${{ steps.meta.outputs.tags }}" | sed 's/^/  - /'
        echo "ğŸ”— Pull command:"
        echo "  docker pull ghcr.io/${{ github.repository_owner }}/tinymediamanager:devel"



  # å‘å¸ƒé˜¶æ®µ
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, docker]
    if: (startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.RELEASE_TOKEN }}
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./release-artifacts
    
    - name: Create GitHub Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Extract version from pom.xml
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "Creating release for version: $VERSION"
        
        # Create release
        gh release create "v$VERSION" \
          --title "tinyMediaManager v$VERSION" \
          --notes "Automated release created by GitHub Actions" \
          --draft \
          ../release-artifacts/**/*

        echo "ğŸ‰ Release v$VERSION created successfully!"
        echo "ğŸ”— Release page: https://github.com/${{ github.repository }}/releases/tag/v$VERSION"
        echo "ğŸ“¦ Download assets from the release page above"

  # é”™è¯¯åˆ†æå’Œè‡ªåŠ¨ä¿®å¤
  auto-fix:
    name: Auto-Fix Build Errors
    runs-on: ubuntu-latest
    needs: [build]
    if: needs.build.result == 'failure'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Analyze and fix errors
      run: |
        echo "ğŸ” Analyzing build errors..."

        # åˆ›å»ºé”™è¯¯ä¿®å¤è„šæœ¬
        cat > fix_errors.sh << 'EOF'
        #!/bin/bash

        echo "ğŸ¤– Starting automatic error analysis and fixing..."

        # æ£€æŸ¥å¸¸è§çš„ç¼–è¯‘é”™è¯¯
        check_and_fix_compilation_errors() {
          echo "ğŸ“ Checking for compilation errors..."

          # æ£€æŸ¥ JUnit ç‰ˆæœ¬å†²çª
          if find src/test -name "*.java" -exec grep -l "org.junit.jupiter" {} \; 2>/dev/null | head -1; then
            echo "ğŸ”§ Found JUnit 5 imports in test files, converting to JUnit 4..."
            find src/test -name "*.java" -exec sed -i.bak \
              -e 's/import org.junit.jupiter.api.Test;/import org.junit.Test;/g' \
              -e 's/import org.junit.jupiter.api.BeforeEach;/import org.junit.Before;/g' \
              -e 's/import org.junit.jupiter.api.Disabled;/import org.junit.Ignore;/g' \
              -e 's/import static org.junit.jupiter.api.Assertions\.\*/import static org.junit.Assert.*;/g' \
              -e 's/@BeforeEach/@Before/g' \
              -e 's/@Disabled/@Ignore/g' \
              -e 's/void test/public void test/g' \
              -e 's/void setUp/public void setUp/g' \
              {} \;
            echo "âœ… JUnit imports fixed"
          fi

          # æ£€æŸ¥ç¼ºå¤±çš„ public ä¿®é¥°ç¬¦
          find src/test -name "*.java" -exec sed -i.bak \
            -e 's/^\s*@Test\s*$/&\n    public/g' \
            {} \;
        }

        # æ£€æŸ¥ Maven é…ç½®é—®é¢˜
        check_and_fix_maven_issues() {
          echo "ğŸ“ Checking Maven configuration..."

          # ç¡®ä¿ Maven å‘½ä»¤æ­£ç¡®
          if ! mvn validate --batch-mode; then
            echo "ğŸ”§ Maven validation failed, checking pom.xml..."
            # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤š Maven ä¿®å¤é€»è¾‘
          fi
        }

        # æ‰§è¡Œä¿®å¤
        check_and_fix_compilation_errors
        check_and_fix_maven_issues

        echo "ğŸ”„ Attempting to build after fixes..."
        mvn clean compile --batch-mode -DskipTests=true

        if [ $? -eq 0 ]; then
          echo "âœ… Compilation successful after auto-fix!"
          mvn package --batch-mode -P dist -DskipSign=true -DskipTests=true -Dmaven.test.skip=true
        else
          echo "âŒ Auto-fix unsuccessful, manual intervention required"
          exit 1
        fi
        EOF

        chmod +x fix_errors.sh
        ./fix_errors.sh

    - name: Commit fixes if successful
      run: |
        if git diff --quiet; then
          echo "â„¹ï¸ No changes made during auto-fix"
        else
          echo "ğŸ“ Committing auto-fixes..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Auto-Fix"
          git add .
          git commit -m "ğŸ¤– Auto-fix: Resolve build errors automatically

          - Fixed JUnit version conflicts
          - Corrected test method signatures
          - Applied common build fixes

          Auto-generated by GitHub Actions"
          git push
          echo "âœ… Auto-fixes committed and pushed"
        fi

  # é€šçŸ¥é˜¶æ®µ
  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build, docker, auto-fix]
    if: always()

    steps:
    - name: Notify success
      if: ${{ needs.build.result == 'success' || needs.auto-fix.result == 'success' }}
      run: |
        if [ "${{ needs.build.result }}" = "success" ]; then
          echo "âœ… Build completed successfully!"
        else
          echo "ğŸ¤– Build fixed automatically!"
        fi
        echo "- Build: ${{ needs.build.result }}"
        echo "- Auto-fix: ${{ needs.auto-fix.result }}"
        echo "- Docker: ${{ needs.docker.result }}"

    - name: Notify failure
      if: ${{ needs.build.result == 'failure' && needs.auto-fix.result == 'failure' }}
      run: |
        echo "âŒ Build failed and auto-fix unsuccessful!"
        echo "- Build: ${{ needs.build.result }}"
        echo "- Auto-fix: ${{ needs.auto-fix.result }}"
        echo "- Docker: ${{ needs.docker.result }}"
        echo ""
        echo "ğŸ”§ Manual intervention required. Common issues to check:"
        echo "1. Check for syntax errors in Java files"
        echo "2. Verify Maven dependencies in pom.xml"
        echo "3. Check for missing imports or package declarations"
        echo "4. Review the build logs above for specific error messages"
        exit 1
