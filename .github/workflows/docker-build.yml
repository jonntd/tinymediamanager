name: Docker Build

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Target platforms'
        required: true
        default: 'linux/amd64,linux/arm64'
        type: choice
        options:
        - linux/amd64
        - linux/arm64
        - linux/amd64,linux/arm64
  workflow_run:
    workflows: ["Multi-Platform CI/CD Pipeline"]
    types:
      - completed
    branches: [ devel ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TMM_VERSION: "5.2.0"

jobs:
  # æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„æž„å»ºäº§ç‰©
  check-artifacts:
    name: Check Build Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    outputs:
      has-linux-amd64: ${{ steps.check.outputs.has-linux-amd64 }}
      has-linux-arm64: ${{ steps.check.outputs.has-linux-arm64 }}

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GHCR_PAT }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Check available artifacts
      id: check
      run: |
        echo "ðŸ” Checking available artifacts..."
        ls -la

        if ls *linux-amd64* 1> /dev/null 2>&1; then
          echo "has-linux-amd64=true" >> $GITHUB_OUTPUT
          echo "âœ… Found Linux AMD64 artifact"
        else
          echo "has-linux-amd64=false" >> $GITHUB_OUTPUT
          echo "âŒ No Linux AMD64 artifact found"
        fi

        if ls *linux-arm64* 1> /dev/null 2>&1; then
          echo "has-linux-arm64=true" >> $GITHUB_OUTPUT
          echo "âœ… Found Linux ARM64 artifact"
        else
          echo "has-linux-arm64=false" >> $GITHUB_OUTPUT
          echo "âŒ No Linux ARM64 artifact found"
        fi

  # æž„å»º AMD64 Docker é•œåƒ
  docker-build-amd64:
    name: Build Docker Image (AMD64)
    runs-on: ubuntu-latest
    needs: check-artifacts
    if: needs.check-artifacts.outputs.has-linux-amd64 == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Linux AMD64 artifact
      if: github.event_name == 'workflow_run'
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GHCR_PAT }}
        run-id: ${{ github.event.workflow_run.id }}
        pattern: "*linux-amd64*"

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    - name: Prepare Docker context
      run: |
        echo "ðŸ—ï¸ Preparing Docker context for AMD64..."
        mkdir -p target/docker

        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          # ä½¿ç”¨æž„å»ºäº§ç‰©
          echo "ðŸ“¦ Extracting build artifacts..."
          tar xJf *linux-amd64*.tar.xz -C target/docker/ || echo "No tar.xz found, trying zip..."
          unzip -q *linux-amd64*.zip -d target/docker/ || echo "No zip found"
        fi

        # åˆ›å»ºå¢žå¼ºç‰ˆ Dockerfile.amd64 (å¸¦ VNC æ”¯æŒ)
        cat > target/docker/Dockerfile.amd64 << 'EOF'
        # ä½¿ç”¨ Ubuntu ä½œä¸ºåŸºç¡€é•œåƒä»¥æ”¯æŒæ›´å¤šåŠŸèƒ½
        FROM ubuntu:22.04

        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        ENV APP=tinyMediaManager
        ENV ALLOW_DIRECT_VNC=true
        ENV LANG=en_US.UTF-8
        ENV LC_ALL=en_US.UTF-8
        ENV LC_TIME=C.UTF-8
        ENV DEBIAN_FRONTEND=noninteractive
        ENV DISPLAY=:1
        ENV VNC_PORT=5901
        ENV NO_VNC_PORT=6901

        # å®‰è£…åŸºç¡€ä¾èµ–å’Œ VNC ç»„ä»¶
        RUN apt-get update && apt-get install -y \
            # Java è¿è¡Œæ—¶
            openjdk-17-jre-headless \
            # å­—ä½“å’Œæœ¬åœ°åŒ–
            fontconfig \
            fonts-dejavu-core \
            locales \
            # VNC å’Œæ¡Œé¢çŽ¯å¢ƒ
            tigervnc-standalone-server \
            tigervnc-common \
            fluxbox \
            # ç½‘ç»œå’Œå·¥å…·
            curl \
            wget \
            # åª’ä½“åº“æ”¯æŒ
            libmediainfo0v5 \
            libzen0v5 \
            # æ¸…ç†
            && apt-get clean \
            && rm -rf /var/lib/apt/lists/* \
            && locale-gen en_US.UTF-8

        # ä¸‹è½½å¹¶å®‰è£… noVNC (åŸºäºŽ Web çš„ VNC å®¢æˆ·ç«¯)
        RUN mkdir -p /opt/novnc /opt/websockify \
            && curl -s -L https://github.com/novnc/noVNC/archive/v1.4.0.tar.gz | tar xzf - -C /opt/novnc --strip-components=1 \
            && curl -s -L https://github.com/novnc/websockify/archive/v0.11.0.tar.gz | tar xzf - -C /opt/websockify --strip-components=1 \
            && ln -s /opt/novnc/vnc.html /opt/novnc/index.html

        # åˆ›å»ºåº”ç”¨ç”¨æˆ·
        RUN groupadd -g 1000 tmm \
            && useradd -u 1000 -g tmm -m -s /bin/bash tmm \
            && mkdir -p /home/tmm/.vnc /data \
            && chown -R tmm:tmm /home/tmm /data

        # è®¾ç½® VNC å¯†ç å’Œé…ç½®
        USER tmm
        RUN echo "tinymediamanager" | vncpasswd -f > /home/tmm/.vnc/passwd \
            && chmod 600 /home/tmm/.vnc/passwd \
            && echo "#!/bin/bash" > /home/tmm/.vnc/xstartup \
            && echo "fluxbox &" >> /home/tmm/.vnc/xstartup \
            && chmod +x /home/tmm/.vnc/xstartup

        # è®¾ç½®å·¥ä½œç›®å½•å¹¶å¤åˆ¶åº”ç”¨æ–‡ä»¶
        WORKDIR /app
        COPY --chown=tmm:tmm tinyMediaManager/ ./
        RUN chmod +x tinyMediaManager

        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        USER root
        RUN cat > /start-services.sh << 'SCRIPT'
        #!/bin/bash
        set -e

        # å¯åŠ¨ VNC æœåŠ¡å™¨
        su - tmm -c "vncserver :1 -geometry 1024x768 -depth 24"

        # å¯åŠ¨ noVNC
        /opt/websockify/run --web /opt/novnc --target-config /opt/novnc/vnc_tokens 6901 &

        # å¯åŠ¨ tinyMediaManager
        cd /app
        su - tmm -c "DISPLAY=:1 /app/tinyMediaManager -Dtmm.contentfolder=/data"
        SCRIPT
        RUN chmod +x /start-services.sh

        # æš´éœ²ç«¯å£
        EXPOSE 5901 6901

        # æ·»åŠ æ ‡ç­¾
        LABEL org.opencontainers.image.title="tinyMediaManager with VNC"
        LABEL org.opencontainers.image.description="tinyMediaManager with VNC and web access support"
        LABEL org.opencontainers.image.vendor="tinyMediaManager"

        # å¯åŠ¨å‘½ä»¤
        CMD ["/start-services.sh"]
        EOF

    - name: Build with Kaniko
      uses: int128/kaniko-action@v1
      with:
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}-amd64-vnc
        file: target/docker/Dockerfile.amd64
        context: target/docker
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

  # æž„å»º ARM64 Docker é•œåƒ
  docker-build-arm64:
    name: Build Docker Image (ARM64)
    runs-on: ubuntu-latest
    needs: check-artifacts
    if: needs.check-artifacts.outputs.has-linux-arm64 == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Linux ARM64 artifact
      if: github.event_name == 'workflow_run'
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GHCR_PAT }}
        run-id: ${{ github.event.workflow_run.id }}
        pattern: "*linux-arm64*"

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    - name: Prepare Docker context
      run: |
        echo "ðŸ—ï¸ Preparing Docker context for ARM64..."
        mkdir -p target/docker

        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          # ä½¿ç”¨æž„å»ºäº§ç‰©
          echo "ðŸ“¦ Extracting build artifacts..."
          tar xJf *linux-arm64*.tar.xz -C target/docker/ || echo "No tar.xz found, trying zip..."
          unzip -q *linux-arm64*.zip -d target/docker/ || echo "No zip found"

          # ARM64 ç‰¹æ®Šå¤„ç† (å‚è€ƒ deploy_release.yml)
          if [ -f target/docker/tinyMediaManager/tinyMediaManager-arm ]; then
            mv target/docker/tinyMediaManager/tinyMediaManager-arm target/docker/tinyMediaManager/tinyMediaManager
          fi
        fi

        # åˆ›å»ºå¢žå¼ºç‰ˆ Dockerfile.arm64 (å¸¦ VNC æ”¯æŒ)
        cat > target/docker/Dockerfile.arm64 << 'EOF'
        # ä½¿ç”¨ Ubuntu ä½œä¸ºåŸºç¡€é•œåƒä»¥æ”¯æŒæ›´å¤šåŠŸèƒ½
        FROM ubuntu:22.04

        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        ENV APP=tinyMediaManager
        ENV ALLOW_DIRECT_VNC=true
        ENV LANG=en_US.UTF-8
        ENV LC_ALL=en_US.UTF-8
        ENV LC_TIME=C.UTF-8
        ENV DEBIAN_FRONTEND=noninteractive
        ENV DISPLAY=:1
        ENV VNC_PORT=5901
        ENV NO_VNC_PORT=6901

        # å®‰è£…åŸºç¡€ä¾èµ–å’Œ VNC ç»„ä»¶
        RUN apt-get update && apt-get install -y \
            # Java è¿è¡Œæ—¶
            openjdk-17-jre-headless \
            # å­—ä½“å’Œæœ¬åœ°åŒ–
            fontconfig \
            fonts-dejavu-core \
            locales \
            # VNC å’Œæ¡Œé¢çŽ¯å¢ƒ
            tigervnc-standalone-server \
            tigervnc-common \
            fluxbox \
            # ç½‘ç»œå’Œå·¥å…·
            curl \
            wget \
            # åª’ä½“åº“æ”¯æŒ (ARM64 ç‰ˆæœ¬)
            libmediainfo0v5 \
            libzen0v5 \
            # æ¸…ç†
            && apt-get clean \
            && rm -rf /var/lib/apt/lists/* \
            && locale-gen en_US.UTF-8

        # ä¸‹è½½å¹¶å®‰è£… noVNC (åŸºäºŽ Web çš„ VNC å®¢æˆ·ç«¯)
        RUN mkdir -p /opt/novnc /opt/websockify \
            && curl -s -L https://github.com/novnc/noVNC/archive/v1.4.0.tar.gz | tar xzf - -C /opt/novnc --strip-components=1 \
            && curl -s -L https://github.com/novnc/websockify/archive/v0.11.0.tar.gz | tar xzf - -C /opt/websockify --strip-components=1 \
            && ln -s /opt/novnc/vnc.html /opt/novnc/index.html

        # åˆ›å»ºåº”ç”¨ç”¨æˆ·
        RUN groupadd -g 1000 tmm \
            && useradd -u 1000 -g tmm -m -s /bin/bash tmm \
            && mkdir -p /home/tmm/.vnc /data \
            && chown -R tmm:tmm /home/tmm /data

        # è®¾ç½® VNC å¯†ç å’Œé…ç½®
        USER tmm
        RUN echo "tinymediamanager" | vncpasswd -f > /home/tmm/.vnc/passwd \
            && chmod 600 /home/tmm/.vnc/passwd \
            && echo "#!/bin/bash" > /home/tmm/.vnc/xstartup \
            && echo "fluxbox &" >> /home/tmm/.vnc/xstartup \
            && chmod +x /home/tmm/.vnc/xstartup

        # è®¾ç½®å·¥ä½œç›®å½•å¹¶å¤åˆ¶åº”ç”¨æ–‡ä»¶
        WORKDIR /app
        COPY --chown=tmm:tmm tinyMediaManager/ ./
        RUN chmod +x tinyMediaManager

        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        USER root
        RUN cat > /start-services.sh << 'SCRIPT'
        #!/bin/bash
        set -e

        # å¯åŠ¨ VNC æœåŠ¡å™¨
        su - tmm -c "vncserver :1 -geometry 1024x768 -depth 24"

        # å¯åŠ¨ noVNC
        /opt/websockify/run --web /opt/novnc --target-config /opt/novnc/vnc_tokens 6901 &

        # å¯åŠ¨ tinyMediaManager
        cd /app
        su - tmm -c "DISPLAY=:1 /app/tinyMediaManager -Dtmm.contentfolder=/data"
        SCRIPT
        RUN chmod +x /start-services.sh

        # æš´éœ²ç«¯å£
        EXPOSE 5901 6901

        # æ·»åŠ æ ‡ç­¾
        LABEL org.opencontainers.image.title="tinyMediaManager with VNC (ARM64)"
        LABEL org.opencontainers.image.description="tinyMediaManager with VNC and web access support for ARM64"
        LABEL org.opencontainers.image.vendor="tinyMediaManager"

        # å¯åŠ¨å‘½ä»¤
        CMD ["/start-services.sh"]
        EOF

    - name: Build with Kaniko
      uses: int128/kaniko-action@v1
      with:
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}-arm64-vnc
        file: target/docker/Dockerfile.arm64
        context: target/docker
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

  # åˆ›å»ºå¤šæž¶æž„ manifest
  docker-manifest:
    name: Create Multi-Arch Manifest
    runs-on: ubuntu-latest
    needs: [docker-build-amd64, docker-build-arm64]
    if: always() && (needs.docker-build-amd64.result == 'success' || needs.docker-build-arm64.result == 'success')
    permissions:
      contents: read
      packages: write

    steps:
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    - name: Create and push manifest
      run: |
        echo "ðŸ—ï¸ Creating multi-arch manifest..."

        # å‡†å¤‡é•œåƒåˆ—è¡¨
        IMAGES=""
        if [ "${{ needs.docker-build-amd64.result }}" = "success" ]; then
          IMAGES="$IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}-amd64-vnc"
        fi
        if [ "${{ needs.docker-build-arm64.result }}" = "success" ]; then
          IMAGES="$IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}-arm64-vnc"
        fi

        echo "Images to include: $IMAGES"

        # åˆ›å»ºå¹¶æŽ¨é€ VNC ç‰ˆæœ¬çš„ manifest
        docker manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}-vnc $IMAGES
        docker manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}-vnc

        # åˆ›å»º latest-vnc æ ‡ç­¾
        docker manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-vnc $IMAGES
        docker manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-vnc

        echo "âœ… Multi-arch manifest created successfully!"
