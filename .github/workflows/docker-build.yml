name: Docker Build

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Target platforms'
        required: true
        default: 'linux/amd64,linux/arm64'
        type: choice
        options:
        - linux/amd64
        - linux/arm64
        - linux/amd64,linux/arm64
  workflow_run:
    workflows: ["Multi-Platform CI/CD Pipeline"]
    types:
      - completed
    branches: [ devel ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TMM_VERSION: "5.2.0"

jobs:
  # æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„æ„å»ºäº§ç‰©
  check-artifacts:
    name: Check Build Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    outputs:
      has-linux-amd64: ${{ steps.check.outputs.has-linux-amd64 }}
      has-linux-arm64: ${{ steps.check.outputs.has-linux-arm64 }}

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GHCR_PAT }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Check available artifacts
      id: check
      run: |
        echo "ğŸ” Checking available artifacts..."
        ls -la
        
        # è¯¦ç»†åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ç”¨äºè°ƒè¯•
        echo "ğŸ“ æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨:"
        find . -type f -name "*" | head -20
        
        # æ£€æŸ¥AMD64æ„å»ºäº§ç‰©ï¼ˆæ”¯æŒå¤šç§å‘½åæ ¼å¼ï¼‰
        AMD64_FILES=$(find . -type f \( -name "*linux-amd64*" -o -name "*amd64*linux*" \) | head -5)
        if [ -n "$AMD64_FILES" ]; then
          echo "âœ… Found AMD64 build files:"
          echo "$AMD64_FILES"
          echo "has-linux-amd64=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ No Linux AMD64 artifact found"
          echo "has-linux-amd64=false" >> $GITHUB_OUTPUT
        fi

        # æ£€æŸ¥ARM64æ„å»ºäº§ç‰©ï¼ˆæ”¯æŒå¤šç§å‘½åæ ¼å¼ï¼‰
        ARM64_FILES=$(find . -type f \( -name "*linux-arm64*" -o -name "*arm64*linux*" \) | head -5)
        if [ -n "$ARM64_FILES" ]; then
          echo "âœ… Found ARM64 build files:"
          echo "$ARM64_FILES"
          echo "has-linux-arm64=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ No Linux ARM64 artifact found"
          echo "has-linux-arm64=false" >> $GITHUB_OUTPUT
        fi

  # æ„å»º AMD64 Docker é•œåƒ
  docker-build-amd64:
    name: Build Docker Image (AMD64)
    runs-on: ubuntu-latest
    needs: check-artifacts
    if: needs.check-artifacts.outputs.has-linux-amd64 == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Linux AMD64 artifact
      if: github.event_name == 'workflow_run'
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GHCR_PAT }}
        run-id: ${{ github.event.workflow_run.id }}
        pattern: "tinyMediaManager-linux-amd64"

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    - name: Prepare Docker context
      run: |
        echo "ğŸ—ï¸ Preparing Docker context for AMD64..."
        mkdir -p target/docker

        # è°ƒè¯•ä¿¡æ¯
        echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ“ ç›®å½•å†…å®¹:"
        ls -la

        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          # ä½¿ç”¨æ„å»ºäº§ç‰©
          echo "ğŸ“¦ Extracting build artifacts..."
          
          # æŸ¥æ‰¾å¯èƒ½çš„artifactç›®å½•ï¼ˆæ”¯æŒå¤šç§å‘½åæ ¼å¼ï¼‰
          ARTIFACT_DIRS=$(find . -type d -name "*linux-amd64*" | head -5)
          ARTIFACT_DIR=""
          
          if [ -n "$ARTIFACT_DIRS" ]; then
            ARTIFACT_DIR=$(echo "$ARTIFACT_DIRS" | head -1)
            echo "âœ… Found artifact directory: $ARTIFACT_DIR"
          else
            # æ£€æŸ¥æ˜¯å¦æœ‰artifactè¢«ä¸‹è½½åˆ°å½“å‰ç›®å½•
            echo "ğŸ” æ£€æŸ¥å½“å‰ç›®å½•ä¸­çš„æ„å»ºäº§ç‰©..."
            ARTIFACT_DIR="."
          fi
          
          # æŸ¥æ‰¾æ„å»ºäº§ç‰©ï¼ˆæ”¯æŒå¤šç§å‘½åæ ¼å¼å’Œå‹ç¼©ç±»å‹ï¼‰
          echo "ğŸ” æŸ¥æ‰¾AMD64æ„å»ºäº§ç‰©..."
          BUILD_FILES=$(find "$ARTIFACT_DIR" -type f \( \
            -name "*tinyMediaManager*linux*amd64*" -o \
            -name "*linux*amd64*tinyMediaManager*" -o \
            -name "*amd64*linux*" \
          \) | head -10)
          
          if [ -n "$BUILD_FILES" ]; then
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©:"
            echo "$BUILD_FILES"
            BUILD_FILE=$(echo "$BUILD_FILES" | head -1)
            
            # åˆ›å»ºç›®æ ‡ç›®å½•
            mkdir -p target/docker/tinyMediaManager
            
            # æ ¹æ®æ–‡ä»¶ç±»å‹è§£å‹
            case "$BUILD_FILE" in
              *.tar.bz2)
                echo "ğŸ“¦ è§£å‹ tar.bz2: $BUILD_FILE"
                tar xjf "$BUILD_FILE" -C target/docker/ || {
                  echo "âŒ tar.bz2 è§£å‹å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
                  exit 1
                }
                ;;
              *.tar.gz)
                echo "ğŸ“¦ è§£å‹ tar.gz: $BUILD_FILE"
                tar xzf "$BUILD_FILE" -C target/docker/ || {
                  echo "âŒ tar.gz è§£å‹å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
                  exit 1
                }
                ;;
              *.tar.xz)
                echo "ğŸ“¦ è§£å‹ tar.xz: $BUILD_FILE"
                tar xJf "$BUILD_FILE" -C target/docker/ || {
                  echo "âŒ tar.xz è§£å‹å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
                  exit 1
                }
                ;;
              *.zip)
                echo "ğŸ“¦ è§£å‹ zip: $BUILD_FILE"
                unzip -q "$BUILD_FILE" -d target/docker/ || {
                  echo "âŒ zip è§£å‹å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
                  exit 1
                }
                ;;
              *)
                echo "âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: $BUILD_FILE"
                echo "ğŸ“ æ–‡ä»¶ä¿¡æ¯:"
                file "$BUILD_FILE"
                exit 1
                ;;
            esac
            
            # éªŒè¯å¹¶ä¿®å¤ç›®å½•ç»“æ„
            echo "ğŸ” éªŒè¯ç›®å½•ç»“æ„..."
            if [ -d "target/docker/tinyMediaManager" ]; then
              echo "âœ… tinyMediaManager ç›®å½•å·²å­˜åœ¨"
            elif [ -d "target/docker/tinyMediaManager-*/tinyMediaManager" ]; then
              echo "ğŸ“‚ æ‰¾åˆ°åµŒå¥—ç›®å½•ï¼Œä¿®å¤ç»“æ„..."
              mv target/docker/tinyMediaManager-*/tinyMediaManager target/docker/
              rm -rf target/docker/tinyMediaManager-*
            else
              echo "ğŸ” æŸ¥æ‰¾tinyMediaManageräºŒè¿›åˆ¶æ–‡ä»¶..."
              BINARY=$(find target/docker -name "tinyMediaManager" -type f -executable | head -1)
              if [ -n "$BINARY" ]; then
                echo "âœ… æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶: $BINARY"
                DIR=$(dirname "$BINARY")
                if [ "$DIR" != "target/docker/tinyMediaManager" ]; then
                  echo "ğŸ“‚ ä¿®å¤ç›®å½•ç»“æ„..."
                  mkdir -p target/docker/tinyMediaManager
                  mv "$BINARY" target/docker/tinyMediaManager/
                fi
              else
                echo "âŒ æœªæ‰¾åˆ°tinyMediaManageräºŒè¿›åˆ¶æ–‡ä»¶"
                echo "ğŸ“ ç›®æ ‡ç›®å½•å†…å®¹:"
                find target/docker -type f | head -20
                exit 1
              fi
            fi
            
            # ç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶å¯æ‰§è¡Œ
            if [ -f "target/docker/tinyMediaManager/tinyMediaManager" ]; then
              chmod +x target/docker/tinyMediaManager/tinyMediaManager
              echo "âœ… tinyMediaManager äºŒè¿›åˆ¶æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª"
            else
              echo "âŒ tinyMediaManager äºŒè¿›åˆ¶æ–‡ä»¶æœªæ‰¾åˆ°"
              exit 1
            fi
            
          else
            echo "âŒ æœªæ‰¾åˆ°AMD64æ„å»ºäº§ç‰©"
            echo "ğŸ“ å¯ç”¨æ–‡ä»¶:"
            find . -type f | grep -E "(amd64|linux)" | head -10
            exit 1
          fi
        else
          echo "ğŸ“ æ‰‹åŠ¨æ„å»ºæ¨¡å¼ - åˆ›å»ºæµ‹è¯•ç»“æ„..."
          mkdir -p target/docker/tinyMediaManager
          cat > target/docker/tinyMediaManager/tinyMediaManager << 'EOF'
#!/bin/bash
echo 'tinyMediaManager AMD64 æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶ v5.2.0'
EOF
          chmod +x target/docker/tinyMediaManager/tinyMediaManager
          echo "âœ… æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶å·²åˆ›å»º"
        fi

        # éªŒè¯æ„å»ºä¸Šä¸‹æ–‡
        echo "ğŸ” éªŒè¯ Docker æ„å»ºä¸Šä¸‹æ–‡..."
        if [ -d "target/docker/tinyMediaManager" ]; then
          echo "âœ… tinyMediaManager ç›®å½•å·²å­˜åœ¨"
          ls -la target/docker/tinyMediaManager/
        else
          echo "âŒ tinyMediaManager ç›®å½•æœªæ‰¾åˆ°"
          exit 1
        fi

        # å¤åˆ¶ Dockerfile
        if [ -f "src/docker/Dockerfile.amd64" ]; then
          cp src/docker/Dockerfile.amd64 target/docker/Dockerfile.amd64
          echo "âœ… Dockerfile.amd64 å¤åˆ¶æˆåŠŸ"
        else
          echo "âŒ æœªæ‰¾åˆ° src/docker/Dockerfile.amd64"
          exit 1
        fi

    - name: Build with Kaniko
      uses: int128/kaniko-action@v1
      with:
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}-amd64
        file: target/docker/Dockerfile.amd64
        context: target/docker
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}
        build-args: |
          HUMAN_VERSION=${{ env.TMM_VERSION }}
          BUILD_NUMBER=${{ github.sha }}

  # æ„å»º ARM64 Docker é•œåƒ
  docker-build-arm64:
    name: Build Docker Image (ARM64)
    runs-on: ubuntu-latest
    needs: check-artifacts
    if: needs.check-artifacts.outputs.has-linux-arm64 == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Linux ARM64 artifact
      if: github.event_name == 'workflow_run'
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GHCR_PAT }}
        run-id: ${{ github.event.workflow_run.id }}
        pattern: "tinyMediaManager-linux-arm64"

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    - name: Prepare Docker context
      run: |
        echo "ğŸ—ï¸ Preparing Docker context for ARM64..."
        mkdir -p target/docker

        # è°ƒè¯•ä¿¡æ¯
        echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ“ ç›®å½•å†…å®¹:"
        ls -la

        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          # ä½¿ç”¨æ„å»ºäº§ç‰©
          echo "ğŸ“¦ Extracting build artifacts..."
          
          # æŸ¥æ‰¾å¯èƒ½çš„artifactç›®å½•ï¼ˆæ”¯æŒå¤šç§å‘½åæ ¼å¼ï¼‰
          ARTIFACT_DIRS=$(find . -type d -name "*linux-arm64*" | head -5)
          ARTIFACT_DIR=""
          
          if [ -n "$ARTIFACT_DIRS" ]; then
            ARTIFACT_DIR=$(echo "$ARTIFACT_DIRS" | head -1)
            echo "âœ… Found artifact directory: $ARTIFACT_DIR"
          else
            # æ£€æŸ¥æ˜¯å¦æœ‰artifactè¢«ä¸‹è½½åˆ°å½“å‰ç›®å½•
            echo "ğŸ” æ£€æŸ¥å½“å‰ç›®å½•ä¸­çš„æ„å»ºäº§ç‰©..."
            ARTIFACT_DIR="."
          fi
          
          # æŸ¥æ‰¾æ„å»ºäº§ç‰©ï¼ˆæ”¯æŒå¤šç§å‘½åæ ¼å¼å’Œå‹ç¼©ç±»å‹ï¼‰
          echo "ğŸ” æŸ¥æ‰¾ARM64æ„å»ºäº§ç‰©..."
          BUILD_FILES=$(find "$ARTIFACT_DIR" -type f \( \
            -name "*tinyMediaManager*linux*arm64*" -o \
            -name "*linux*arm64*tinyMediaManager*" -o \
            -name "*arm64*linux*" \
          \) | head -10)
          
          if [ -n "$BUILD_FILES" ]; then
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©:"
            echo "$BUILD_FILES"
            BUILD_FILE=$(echo "$BUILD_FILES" | head -1)
            
            # åˆ›å»ºç›®æ ‡ç›®å½•
            mkdir -p target/docker/tinyMediaManager
            
            # æ ¹æ®æ–‡ä»¶ç±»å‹è§£å‹
            case "$BUILD_FILE" in
              *.tar.bz2)
                echo "ğŸ“¦ è§£å‹ tar.bz2: $BUILD_FILE"
                tar xjf "$BUILD_FILE" -C target/docker/ || {
                  echo "âŒ tar.bz2 è§£å‹å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
                  exit 1
                }
                ;;
              *.tar.gz)
                echo "ğŸ“¦ è§£å‹ tar.gz: $BUILD_FILE"
                tar xzf "$BUILD_FILE" -C target/docker/ || {
                  echo "âŒ tar.gz è§£å‹å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
                  exit 1
                }
                ;;
              *.tar.xz)
                echo "ğŸ“¦ è§£å‹ tar.xz: $BUILD_FILE"
                tar xJf "$BUILD_FILE" -C target/docker/ || {
                  echo "âŒ tar.xz è§£å‹å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
                  exit 1
                }
                ;;
              *.zip)
                echo "ğŸ“¦ è§£å‹ zip: $BUILD_FILE"
                unzip -q "$BUILD_FILE" -d target/docker/ || {
                  echo "âŒ zip è§£å‹å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
                  exit 1
                }
                ;;
              *)
                echo "âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: $BUILD_FILE"
                echo "ğŸ“ æ–‡ä»¶ä¿¡æ¯:"
                file "$BUILD_FILE"
                exit 1
                ;;
            esac
            
            # éªŒè¯å¹¶ä¿®å¤ç›®å½•ç»“æ„
            echo "ğŸ” éªŒè¯ç›®å½•ç»“æ„..."
            if [ -d "target/docker/tinyMediaManager" ]; then
              echo "âœ… tinyMediaManager ç›®å½•å·²å­˜åœ¨"
            elif [ -d "target/docker/tinyMediaManager-*/tinyMediaManager" ]; then
              echo "ğŸ“‚ æ‰¾åˆ°åµŒå¥—ç›®å½•ï¼Œä¿®å¤ç»“æ„..."
              mv target/docker/tinyMediaManager-*/tinyMediaManager target/docker/
              rm -rf target/docker/tinyMediaManager-*
            else
              echo "ğŸ” æŸ¥æ‰¾tinyMediaManageräºŒè¿›åˆ¶æ–‡ä»¶..."
              BINARY=$(find target/docker -name "tinyMediaManager" -type f -executable | head -1)
              if [ -n "$BINARY" ]; then
                echo "âœ… æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶: $BINARY"
                DIR=$(dirname "$BINARY")
                if [ "$DIR" != "target/docker/tinyMediaManager" ]; then
                  echo "ğŸ“‚ ä¿®å¤ç›®å½•ç»“æ„..."
                  mkdir -p target/docker/tinyMediaManager
                  mv "$BINARY" target/docker/tinyMediaManager/
                fi
              else
                echo "âŒ æœªæ‰¾åˆ°tinyMediaManageräºŒè¿›åˆ¶æ–‡ä»¶"
                echo "ğŸ“ ç›®æ ‡ç›®å½•å†…å®¹:"
                find target/docker -type f | head -20
                exit 1
              fi
            fi
            
            # é‡å‘½åARM64äºŒè¿›åˆ¶æ–‡ä»¶
            if [ -f "target/docker/tinyMediaManager/tinyMediaManager" ]; then
              mv target/docker/tinyMediaManager/tinyMediaManager target/docker/tinyMediaManager/tinyMediaManager-arm64
              chmod +x target/docker/tinyMediaManager/tinyMediaManager-arm64
              echo "âœ… tinyMediaManager ARM64 äºŒè¿›åˆ¶æ–‡ä»¶å·²é‡å‘½åå¹¶å‡†å¤‡å°±ç»ª"
            else
              echo "âŒ tinyMediaManager äºŒè¿›åˆ¶æ–‡ä»¶æœªæ‰¾åˆ°"
              exit 1
            fi
            
          else
            echo "âŒ æœªæ‰¾åˆ°ARM64æ„å»ºäº§ç‰©"
            echo "ğŸ“ å¯ç”¨æ–‡ä»¶:"
            find . -type f | grep -E "(arm64|linux)" | head -10
            exit 1
          fi
        else
          echo "ğŸ“ æ‰‹åŠ¨æ„å»ºæ¨¡å¼ - åˆ›å»ºæµ‹è¯•ç»“æ„..."
          mkdir -p target/docker/tinyMediaManager
          cat > target/docker/tinyMediaManager/tinyMediaManager-arm64 << 'EOF'
#!/bin/bash
echo 'tinyMediaManager ARM64 æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶ v5.2.0'
EOF
          chmod +x target/docker/tinyMediaManager/tinyMediaManager-arm64
          echo "âœ… æµ‹è¯•ARM64äºŒè¿›åˆ¶æ–‡ä»¶å·²åˆ›å»º"
        fi

        # éªŒè¯æ„å»ºä¸Šä¸‹æ–‡
        echo "ğŸ” éªŒè¯ Docker æ„å»ºä¸Šä¸‹æ–‡..."
        if [ -d "target/docker/tinyMediaManager" ]; then
          echo "âœ… tinyMediaManager ç›®å½•å·²å­˜åœ¨"
          ls -la target/docker/tinyMediaManager/
        else
          echo "âŒ tinyMediaManager ç›®å½•æœªæ‰¾åˆ°"
          exit 1
        fi

        # å¤åˆ¶ Dockerfile
        if [ -f "src/docker/Dockerfile.arm64" ]; then
          cp src/docker/Dockerfile.arm64 target/docker/Dockerfile.arm64
          echo "âœ… Dockerfile.arm64 å¤åˆ¶æˆåŠŸ"
        else
          echo "âŒ æœªæ‰¾åˆ° src/docker/Dockerfile.arm64"
          exit 1
        fi

    - name: Build with Kaniko
      uses: int128/kaniko-action@v1
      with:
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}-arm64
        file: target/docker/Dockerfile.arm64
        context: target/docker
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}
        build-args: |
          HUMAN_VERSION=${{ env.TMM_VERSION }}
          BUILD_NUMBER=${{ github.sha }}

  # åˆ›å»ºå¤šæ¶æ„ manifest
  docker-manifest:
    name: Create Multi-Arch Manifest
    runs-on: ubuntu-latest
    needs: [docker-build-amd64, docker-build-arm64]
    if: always() && (needs.docker-build-amd64.result == 'success' || needs.docker-build-arm64.result == 'success')
    permissions:
      contents: read
      packages: write

    steps:
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    - name: Create and push manifest
      run: |
        echo "ğŸ—ï¸ Creating multi-arch manifest..."

        # å‡†å¤‡é•œåƒåˆ—è¡¨
        IMAGES=""
        if [ "${{ needs.docker-build-amd64.result }}" = "success" ]; then
          IMAGES="$IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}-amd64"
        fi
        if [ "${{ needs.docker-build-arm64.result }}" = "success" ]; then
          IMAGES="$IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}-arm64"
        fi

        echo "Images to include: $IMAGES"

        # åˆ›å»ºå¹¶æ¨é€ manifest
        docker manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }} $IMAGES
        docker manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TMM_VERSION }}

        # åˆ›å»º latest æ ‡ç­¾
        docker manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest $IMAGES
        docker manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

        echo "âœ… Multi-arch manifest created successfully!"
