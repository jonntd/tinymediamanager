name: Docker Build

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Target platforms'
        required: true
        default: 'linux/amd64,linux/arm64'
        type: choice
        options:
        - linux/amd64
        - linux/arm64
        - linux/amd64,linux/arm64
  workflow_run:
    workflows: ["Multi-Platform CI/CD Pipeline"]
    types: [completed]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # æ¸…ç†æ—§çš„Dockerç‰ˆæœ¬
  cleanup-docker-versions:
    name: Cleanup Docker Versions
    uses: ./.github/workflows/delete-all-docker-versions.yml
    with:
      keep_latest: true

  # æ£€æŸ¥æ„å»ºç¯å¢ƒ
  check-environment:
    name: Check Environment
    runs-on: ubuntu-latest
    needs: cleanup-docker-versions
    outputs:
      has-upstream-artifacts: ${{ steps.check.outputs.has-upstream }}
      build-type: ${{ steps.check.outputs.build-type }}
      should-build: ${{ steps.check.outputs.should-build }}
      version: ${{ steps.version.outputs.version }}
      image-tags: ${{ steps.version.outputs.image-tags }}
      is-release: ${{ steps.version.outputs.is-release }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK for version extraction
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Extract version information
      id: version
      run: |
        echo "ğŸ” æå–ç‰ˆæœ¬ä¿¡æ¯..."
        echo "ğŸ” äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
        echo "ğŸ” GitHub Ref: ${{ github.ref }}"
        echo "ğŸ” Repository: ${{ github.repository }}"

        # åŠ¨æ€ç‰ˆæœ¬ç­–ç•¥ï¼Œä½¿ç”¨åŸºäºMavenç‰ˆæœ¬å’Œcommitçš„ç‰ˆæœ¬å·
        echo "ğŸ“‹ è·å–ç‰ˆæœ¬ä¿¡æ¯..."
        MAVEN_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout 2>/dev/null || echo "unknown")
        echo "ğŸ“‹ Mavenç‰ˆæœ¬: $MAVEN_VERSION"

        # åˆ†ææ„å»ºä¸Šä¸‹æ–‡
        echo "ğŸ“Š åˆ†ææ„å»ºä¸Šä¸‹æ–‡..."
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        BUILD_DATE=$(date +%Y%m%d-%H%M%S)

        # ç¡®å®šç‰ˆæœ¬ç­–ç•¥
        IS_DEVEL_BUILD=false
        IS_TAG_BUILD=false
        RELEASE_VERSION=""

        # æ£€æŸ¥æ˜¯å¦æ˜¯tagæ„å»º
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          IS_TAG_BUILD=true
          RELEASE_VERSION="${GITHUB_REF#refs/tags/v}"
          echo "ğŸ·ï¸ Tagæ„å»ºç‰ˆæœ¬: $RELEASE_VERSION"
        elif [[ "${{ github.ref }}" == refs/heads/devel || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          IS_DEVEL_BUILD=true
          echo "ğŸš€ Develåˆ†æ”¯æ„å»º"
        else
          echo "ğŸ”„ å…¶ä»–åˆ†æ”¯æ„å»º: ${{ github.ref }}"
        fi

        # æ„é€ ç‰ˆæœ¬å·
        if [ "$IS_TAG_BUILD" = true ]; then
          # Tagæ„å»ºï¼šä½¿ç”¨æ¸…æ´çš„ç‰ˆæœ¬å·
          VERSION="$RELEASE_VERSION"
          IMAGE_TAGS="$RELEASE_VERSION"
          echo "ğŸ·ï¸ Tagç‰ˆæœ¬æ ‡ç­¾: $IMAGE_TAGS"
        else
          # å…¶ä»–æ„å»ºï¼šä½¿ç”¨commitä¿¡æ¯
          BASE_VERSION="${MAVEN_VERSION%-SNAPSHOT}"
          VERSION="${BASE_VERSION}-${SHORT_SHA}"
          IMAGE_TAGS="devel"

          # å¯¹äºdevelæ„å»ºï¼Œä¹Ÿè€ƒè™‘æ·»åŠ æ—¶é—´æˆ³
          if [ "$IS_DEVEL_BUILD" = true ]; then
            IMAGE_TAGS="$IMAGE_TAGS,dev-${SHORT_SHA}"
          fi

          echo "ğŸ·ï¸ Develç‰ˆæœ¬æ ‡ç­¾: $IMAGE_TAGS"
        fi

        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "image-tags=$IMAGE_TAGS" >> $GITHUB_OUTPUT
        echo "release-version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
        echo "build-date=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ æœ€ç»ˆç‰ˆæœ¬: $VERSION"
        echo "ğŸ·ï¸ é•œåƒæ ‡ç­¾: $IMAGE_TAGS"

    - name: Check for upstream artifacts
      id: check
      run: |
        echo "ğŸ” æ£€æŸ¥æ„å»ºç¯å¢ƒ..."

        # æ£€æŸ¥æ˜¯å¦åº”è¯¥æ„å»ºï¼ˆåªè¦æœ‰ä¸Šæ¸¸ç¼–è¯‘å®Œæˆå°±æ„å»ºï¼‰
        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          echo "ğŸ” workflow_runäº‹ä»¶è¯¦æƒ…ï¼š"
          echo "  å·¥ä½œæµåç§°: ${{ github.event.workflow_run.name }}"
          echo "  å·¥ä½œæµç»“è®º: ${{ github.event.workflow_run.conclusion }}"
          echo "  å·¥ä½œæµçŠ¶æ€: ${{ github.event.workflow_run.status }}"
          echo "  å¤´åˆ†æ”¯: ${{ github.event.workflow_run.head_branch }}"
          echo "  å¤´SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "  äº‹ä»¶: ${{ github.event.workflow_run.event }}"

          if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            # åªè¦æœ‰æˆåŠŸçš„ä¸Šæ¸¸ç¼–è¯‘å®Œæˆå°±æ„å»ºDockeré•œåƒ
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "has-upstream=true" >> $GITHUB_OUTPUT
            echo "build-type=auto" >> $GITHUB_OUTPUT
            echo "âœ… ä¸Šæ¸¸CIå·¥ä½œæµå®Œæˆï¼Œå¼€å§‹Dockeræ„å»º"
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "has-upstream=false" >> $GITHUB_OUTPUT
            echo "build-type=none" >> $GITHUB_OUTPUT
            echo "âŒ ä¸Šæ¸¸å·¥ä½œæµæœªå®Œæˆï¼Œè·³è¿‡æ„å»º"
          fi
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "has-upstream=false" >> $GITHUB_OUTPUT
          echo "build-type=local" >> $GITHUB_OUTPUT
          echo "âœ… æ‰‹åŠ¨è§¦å‘æ„å»º"
        else
          echo "should-build=false" >> $GITHUB_OUTPUT
          echo "has-upstream=false" >> $GITHUB_OUTPUT
          echo "build-type=none" >> $GITHUB_OUTPUT
          echo "âš ï¸ æœªçŸ¥è§¦å‘æºï¼Œè·³è¿‡æ„å»º"
          echo "â„¹ï¸ åªæ”¯æŒæ ‡ç­¾è§¦å‘çš„CIå®Œæˆåæ„å»ºæˆ–æ‰‹åŠ¨è§¦å‘"
        fi

  # æ„å»º AMD64 Docker é•œåƒ
  docker-build-amd64:
    name: Build Docker Image (AMD64)
    runs-on: ubuntu-latest
    needs: check-environment
    # åªåœ¨æ˜ç¡®éœ€è¦æ„å»ºæ—¶æ‰§è¡Œï¼ˆé˜²æ­¢é‡å¤è§¦å‘ï¼‰
    if: needs.check-environment.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && github.ref || 'devel') }}

    - name: Download Linux AMD64 artifact (from upstream workflow)
      if: needs.check-environment.outputs.has-upstream-artifacts == 'true' && github.event.workflow_run.conclusion == 'success'
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
        pattern: "tinymediamanager-linux-amd64*"
        path: artifacts

    - name: Download Linux AMD64 artifact (from current workflow)
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        pattern: "tinymediamanager-linux-amd64*"
        path: artifacts

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Prepare Docker context
      run: |
        echo "ğŸ—ï¸ Preparing Docker context for AMD64..."
        mkdir -p target/docker

        # è°ƒè¯•ä¿¡æ¯
        echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ“ src/dockerç›®å½•å†…å®¹:"
        ls -la src/docker/
        echo "ğŸ“ å½“å‰ç›®å½•æ‰€æœ‰æ–‡ä»¶:"
        find . -name "*Dockerfile*" -type f

        # æ˜¾ç¤ºä¸‹è½½çš„æ„å»ºäº§ç‰©
        echo "ğŸ“ ä¸‹è½½çš„æ„å»ºäº§ç‰©:"
        ls -la . | grep -E "(tinyMediaManager|tinymediamanager)" || echo "æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•"

        # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºäº§ç‰©
        HAS_ARTIFACTS=false

        # é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ä¸‹è½½çš„æ„å»ºäº§ç‰©ç›®å½•ï¼ˆGitHub Actions download-artifact ä¼šåˆ›å»ºç›®å½•ï¼‰
        ARTIFACT_DIRS=$(find . -maxdepth 1 -type d -name "*linux*amd64*" -o -name "*tinymediamanager*amd64*" -o -name "tinymediamanager-linux-amd64*" | head -5)
        echo "ğŸ” æŸ¥æ‰¾æ„ä»¶ç›®å½•ç»“æœ: $ARTIFACT_DIRS"

        if [ -n "$ARTIFACT_DIRS" ]; then
          echo "ğŸ“¦ æ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•:"
          echo "$ARTIFACT_DIRS"

          # å¤„ç†ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç›®å½•
          ARTIFACT_DIR=$(echo "$ARTIFACT_DIRS" | head -1)
          echo "ğŸ“‚ å¤„ç†ç›®å½•: $ARTIFACT_DIR"

          # æ˜¾ç¤ºç›®å½•å†…å®¹
          echo "ğŸ“ ç›®å½•å†…å®¹:"
          ls -la "$ARTIFACT_DIR"

          # æŸ¥æ‰¾ç›®å½•ä¸­çš„æ„å»ºäº§ç‰©æ–‡ä»¶
          BUILD_FILES=$(find "$ARTIFACT_DIR" -type f \( \
            -name "*.tar.xz" -o \
            -name "*.tar.gz" -o \
            -name "*.zip" -o \
            -name "*tinyMediaManager*" \
          \) | head -10)
          echo "ğŸ” åœ¨æ„ä»¶ç›®å½•ä¸­æŸ¥æ‰¾æ–‡ä»¶ç»“æœ: $BUILD_FILES"

          if [ -n "$BUILD_FILES" ]; then
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©æ–‡ä»¶:"
            echo "$BUILD_FILES"

            # å¤„ç†ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶
            BUILD_FILE=$(echo "$BUILD_FILES" | head -1)
            echo "ğŸ“¦ å¤„ç†æ–‡ä»¶: $BUILD_FILE"

            # åˆ›å»ºç›®æ ‡ç›®å½•
            mkdir -p target/docker

            # æ ¹æ®æ–‡ä»¶ç±»å‹å¤„ç†
            case "$BUILD_FILE" in
              *.tar.xz)
                echo "ğŸ“¦ è§£å‹ tar.xz æ–‡ä»¶: $BUILD_FILE"
                tar xJf "$BUILD_FILE" -C target/docker/ || {
                  echo "âŒ tar.xz è§£å‹å¤±è´¥"
                  exit 1
                }
                ;;
              *.tar.gz)
                echo "ğŸ“¦ è§£å‹ tar.gz æ–‡ä»¶: $BUILD_FILE"
                tar xzf "$BUILD_FILE" -C target/docker/ || {
                  echo "âŒ tar.gz è§£å‹å¤±è´¥"
                  exit 1
                }
                ;;
              *.zip)
                echo "ğŸ“¦ è§£å‹ zip æ–‡ä»¶: $BUILD_FILE"
                unzip -q "$BUILD_FILE" -d target/docker/ || {
                  echo "âŒ zip è§£å‹å¤±è´¥"
                  exit 1
                }
                ;;
              *)
                echo "ğŸ“‹ ç›´æ¥å¤åˆ¶æ–‡ä»¶: $BUILD_FILE"
                mkdir -p target/docker/tinyMediaManager
                cp "$BUILD_FILE" target/docker/tinyMediaManager/
                ;;
            esac

            HAS_ARTIFACTS=true
          else
            echo "âš ï¸ ç›®å½•ä¸­æœªæ‰¾åˆ°å¯è¯†åˆ«çš„æ„å»ºäº§ç‰©æ–‡ä»¶"
            echo "ğŸ“ å°è¯•ç›´æ¥å¤åˆ¶æ•´ä¸ªç›®å½•å†…å®¹..."

            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šæ–‡ä»¶ï¼Œå°è¯•å¤åˆ¶æ•´ä¸ªç›®å½•
            if [ -d "$ARTIFACT_DIR" ]; then
              mkdir -p target/docker
              cp -r "$ARTIFACT_DIR"/* target/docker/ 2>/dev/null || {
                echo "âš ï¸ ç›´æ¥å¤åˆ¶å¤±è´¥"
                exit 1
              }

              # æ£€æŸ¥æ˜¯å¦æˆåŠŸå¤åˆ¶äº† tinyMediaManager ç›®å½•
              if [ -d "target/docker/tinyMediaManager" ]; then
                echo "âœ… æˆåŠŸå¤åˆ¶æ„å»ºäº§ç‰©ç›®å½•"
                HAS_ARTIFACTS=true
              else
                echo "âŒ æœªèƒ½æ‰¾åˆ° tinyMediaManager ç›®å½•"
                echo "ğŸ“ target/docker ç›®å½•å†…å®¹:"
                ls -la target/docker/
                exit 1
              fi
            else
              echo "âŒ æ„ä»¶ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•ï¼Œæ£€æŸ¥ artifacts ç›®å½•..."

          # æ£€æŸ¥ä¼ ç»Ÿçš„ artifacts ç›®å½•
          if [ -d "artifacts" ]; then
            echo "ğŸ“¦ å¤„ç† artifacts ç›®å½•..."
            cd artifacts
            echo "ğŸ“ artifacts ç›®å½•å†…å®¹:"
            ls -la .

            # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„æ„å»ºäº§ç‰©
            echo "ğŸ” æŸ¥æ‰¾AMD64æ„å»ºäº§ç‰©..."
            BUILD_FILES=$(find . -type f \( \
              -name "*linux*amd64*" -o \
              -name "*amd64*linux*" -o \
              -name "*tinymediamanager*amd64*" -o \
              -name "*tinymediamanager*linux*amd64*" -o \
              -name "tinymediamanager-linux-amd64*" \
            \) | head -10)
            echo "ğŸ” åœ¨artifactsç›®å½•ä¸­æŸ¥æ‰¾æ–‡ä»¶ç»“æœ: $BUILD_FILES"

            if [ -n "$BUILD_FILES" ]; then
              echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©:"
              echo "$BUILD_FILES"

              # å¤„ç†ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶
              BUILD_FILE=$(echo "$BUILD_FILES" | head -1)
              echo "ğŸ“¦ å¤„ç†æ–‡ä»¶: $BUILD_FILE"

              # åˆ›å»ºç›®æ ‡ç›®å½•
              mkdir -p ../target/docker/tinyMediaManager

              # æ ¹æ®æ–‡ä»¶ç±»å‹å¤„ç†
              case "$BUILD_FILE" in
                *.tar.*)
                  echo "ğŸ“¦ è§£å‹ tar æ–‡ä»¶: $BUILD_FILE"
                  tar xf "$BUILD_FILE" -C ../target/docker/ || {
                    echo "âŒ tar è§£å‹å¤±è´¥"
                    exit 1
                  }
                  ;;
                *.zip)
                  echo "ğŸ“¦ è§£å‹ zip æ–‡ä»¶: $BUILD_FILE"
                  unzip -q "$BUILD_FILE" -d ../target/docker/ || {
                    echo "âŒ zip è§£å‹å¤±è´¥"
                    exit 1
                  }
                  ;;
                *)
                  echo "ğŸ“‹ ç›´æ¥å¤åˆ¶æ–‡ä»¶: $BUILD_FILE"
                  cp "$BUILD_FILE" ../target/docker/tinyMediaManager/
                  ;;
              esac

              cd ..
              HAS_ARTIFACTS=true
            else
              echo "âŒ artifacts ç›®å½•ä¸­æœªæ‰¾åˆ°ä¸Šæ¸¸æ„å»ºäº§ç‰©"
              cd ..
              exit 1
            fi
          else
            echo "âŒ æ— ä¸Šæ¸¸æ„å»ºäº§ç‰©ï¼Œæ— æ³•ç»§ç»­æ„å»º"
            exit 1
          fi
        fi

        # éªŒè¯æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
        if [ "$HAS_ARTIFACTS" = "false" ]; then
          echo "âŒ æœªèƒ½æˆåŠŸå¤„ç†æ„å»ºäº§ç‰©"
          exit 1
        fi

        # æ˜¾ç¤ºæœ€ç»ˆç›®å½•ç»“æ„
        echo "ğŸ“ æœ€ç»ˆç›®å½•ç»“æ„:"
        find target/docker -type f

        # éªŒè¯tinyMediaManagerç›®å½•æ˜¯å¦å­˜åœ¨
        if [ ! -d "target/docker/tinyMediaManager" ]; then
          echo "âŒ æœªæ‰¾åˆ° tinyMediaManager ç›®å½•"
          echo "ğŸ’¡ è¯·æ£€æŸ¥æ„ä»¶æ˜¯å¦æ­£ç¡®ä¸‹è½½å’Œå¤„ç†"
          echo "ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š"
          echo "   1. ä¸Šæ¸¸å·¥ä½œæµæœªæä¾›æ­£ç¡®çš„æ„ä»¶"
          echo "   2. æ„ä»¶åç§°ä¸é¢„æœŸä¸åŒ¹é…"
          echo "   3. æ„ä»¶ä¸‹è½½å¤±è´¥"
          echo "   4. æ„ä»¶è§£å‹æˆ–å¤„ç†å¤±è´¥"
          exit 1
        fi

        # éªŒè¯tinyMediaManageräºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆæ”¯æŒæ¶æ„ç‰¹å®šå‘½åï¼‰
        if [ -f "target/docker/tinyMediaManager/tinyMediaManager" ]; then
          echo "âœ… æ‰¾åˆ° tinyMediaManager äºŒè¿›åˆ¶æ–‡ä»¶"
        elif [ -f "target/docker/tinyMediaManager/tinyMediaManager-arm" ]; then
          echo "ğŸ”„ é‡å‘½å ARM64 äºŒè¿›åˆ¶æ–‡ä»¶: tinyMediaManager-arm -> tinyMediaManager"
          mv target/docker/tinyMediaManager/tinyMediaManager-arm target/docker/tinyMediaManager/tinyMediaManager
          chmod +x target/docker/tinyMediaManager/tinyMediaManager
          echo "âœ… ARM64 äºŒè¿›åˆ¶æ–‡ä»¶é‡å‘½åå®Œæˆ"
        elif [ -f "target/docker/tinyMediaManager/tinyMediaManager-amd64" ]; then
          echo "ğŸ”„ é‡å‘½å AMD64 äºŒè¿›åˆ¶æ–‡ä»¶: tinyMediaManager-amd64 -> tinyMediaManager"
          mv target/docker/tinyMediaManager/tinyMediaManager-amd64 target/docker/tinyMediaManager/tinyMediaManager
          chmod +x target/docker/tinyMediaManager/tinyMediaManager
          echo "âœ… AMD64 äºŒè¿›åˆ¶æ–‡ä»¶é‡å‘½åå®Œæˆ"
        else
          echo "âŒ æœªæ‰¾åˆ° tinyMediaManager äºŒè¿›åˆ¶æ–‡ä»¶"
          echo "ğŸ“ tinyMediaManager ç›®å½•å†…å®¹:"
          ls -la target/docker/tinyMediaManager/
          echo "ğŸ’¡ è¯·æ£€æŸ¥æ„ä»¶æ˜¯å¦åŒ…å«æ­£ç¡®çš„äºŒè¿›åˆ¶æ–‡ä»¶"
          exit 1
        fi

        echo "âœ… æ„ä»¶å¤„ç†å®Œæˆï¼Œå‡†å¤‡æ„å»ºDockeré•œåƒ"

        # å¤åˆ¶Dockerfile
        if [ -f "src/docker/Dockerfile.amd64" ]; then
          cp src/docker/Dockerfile.amd64 target/docker/Dockerfile
          echo "âœ… æˆåŠŸå¤åˆ¶Dockerfile.amd64"
        else
          echo "âŒ æ— æ³•æ‰¾åˆ°src/docker/Dockerfile.amd64"
          echo "ğŸ“ src/dockerç›®å½•å†…å®¹:"
          ls -la src/docker/
          exit 1
        fi

        # äºŒè¿›åˆ¶æ–‡ä»¶é‡å‘½åå°†åœ¨éªŒè¯æ­¥éª¤ä¸­ç»Ÿä¸€å¤„ç†

        echo "âœ… Dockerä¸Šä¸‹æ–‡å‡†å¤‡å®Œæˆ"
        echo "ğŸ“ æœ€ç»ˆç›®å½•ç»“æ„:"
        find target/docker -type f

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push AMD64 image
      uses: docker/build-push-action@v5
      with:
        context: target/docker
        file: target/docker/Dockerfile
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.check-environment.outputs.version }}-amd64
        labels: |
          org.opencontainers.image.title=tinyMediaManager
          org.opencontainers.image.description=A comprehensive media management tool for organizing and managing your movie and TV show collections. Features automatic metadata fetching, artwork downloading, and extensive customization options.
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.url=https://www.tinymediamanager.org
          org.opencontainers.image.documentation=https://www.tinymediamanager.org/docs/docker
          org.opencontainers.image.licenses=Apache-2.0
          org.opencontainers.image.vendor=tinyMediaManager
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.version=${{ needs.check-environment.outputs.version }}

  # æ„å»º ARM64 Docker é•œåƒ
  docker-build-arm64:
    name: Build Docker Image (ARM64)
    runs-on: ubuntu-latest
    needs: check-environment
    # åªåœ¨æ˜ç¡®éœ€è¦æ„å»ºæ—¶æ‰§è¡Œï¼ˆé˜²æ­¢é‡å¤è§¦å‘ï¼‰
    if: needs.check-environment.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && github.ref || 'devel') }}

    - name: Download Linux ARM64 artifact (from upstream workflow)
      if: needs.check-environment.outputs.has-upstream-artifacts == 'true' && github.event.workflow_run.conclusion == 'success'
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
        pattern: "tinymediamanager-linux-arm64*"
        path: artifacts

    - name: Download Linux ARM64 artifact (from current workflow)
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        pattern: "tinymediamanager-linux-arm64*"
        path: artifacts

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Prepare Docker context
      run: |
        echo "ğŸ—ï¸ Preparing Docker context for ARM64..."
        mkdir -p target/docker

        # è°ƒè¯•ä¿¡æ¯
        echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ“ src/dockerç›®å½•å†…å®¹:"
        ls -la src/docker/
        echo "ğŸ“ å½“å‰ç›®å½•æ‰€æœ‰æ–‡ä»¶:"
        find . -name "*Dockerfile*" -type f

        # æ˜¾ç¤ºä¸‹è½½çš„æ„å»ºäº§ç‰©
        echo "ğŸ“ ä¸‹è½½çš„æ„å»ºäº§ç‰©:"
        ls -la . | grep -E "(tinyMediaManager|tinymediamanager)" || echo "æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•"

        # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºäº§ç‰©
        HAS_ARTIFACTS=false

        # é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ä¸‹è½½çš„æ„å»ºäº§ç‰©ç›®å½•ï¼ˆGitHub Actions download-artifact ä¼šåˆ›å»ºç›®å½•ï¼‰
        ARTIFACT_DIRS=$(find . -maxdepth 1 -type d -name "*linux*arm64*" -o -name "*tinymediamanager*arm64*" -o -name "tinymediamanager-linux-arm64*" | head -5)
        echo "ğŸ” æŸ¥æ‰¾æ„ä»¶ç›®å½•ç»“æœ: $ARTIFACT_DIRS"

        if [ -n "$ARTIFACT_DIRS" ]; then
          echo "ğŸ“¦ æ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•:"
          echo "$ARTIFACT_DIRS"

          # å¤„ç†ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç›®å½•
          ARTIFACT_DIR=$(echo "$ARTIFACT_DIRS" | head -1)
          echo "ğŸ“‚ å¤„ç†ç›®å½•: $ARTIFACT_DIR"

          # æ˜¾ç¤ºç›®å½•å†…å®¹
          echo "ğŸ“ ç›®å½•å†…å®¹:"
          ls -la "$ARTIFACT_DIR"

          # æŸ¥æ‰¾ç›®å½•ä¸­çš„æ„å»ºäº§ç‰©æ–‡ä»¶
          BUILD_FILES=$(find "$ARTIFACT_DIR" -type f \( \
            -name "*.tar.xz" -o \
            -name "*.tar.gz" -o \
            -name "*.zip" -o \
            -name "*tinyMediaManager*" \
          \) | head -10)
          echo "ğŸ” åœ¨æ„ä»¶ç›®å½•ä¸­æŸ¥æ‰¾æ–‡ä»¶ç»“æœ: $BUILD_FILES"

          if [ -n "$BUILD_FILES" ]; then
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©æ–‡ä»¶:"
            echo "$BUILD_FILES"

            # å¤„ç†ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶
            BUILD_FILE=$(echo "$BUILD_FILES" | head -1)
            echo "ğŸ“¦ å¤„ç†æ–‡ä»¶: $BUILD_FILE"

            # åˆ›å»ºç›®æ ‡ç›®å½•
            mkdir -p target/docker

            # æ ¹æ®æ–‡ä»¶ç±»å‹å¤„ç†
            case "$BUILD_FILE" in
              *.tar.xz)
                echo "ğŸ“¦ è§£å‹ tar.xz æ–‡ä»¶: $BUILD_FILE"
                tar xJf "$BUILD_FILE" -C target/docker/ || {
                  echo "âŒ tar.xz è§£å‹å¤±è´¥"
                  exit 1
                }
                ;;
              *.tar.gz)
                echo "ğŸ“¦ è§£å‹ tar.gz æ–‡ä»¶: $BUILD_FILE"
                tar xzf "$BUILD_FILE" -C target/docker/ || {
                  echo "âŒ tar.gz è§£å‹å¤±è´¥"
                  exit 1
                }
                ;;
              *.zip)
                echo "ğŸ“¦ è§£å‹ zip æ–‡ä»¶: $BUILD_FILE"
                unzip -q "$BUILD_FILE" -d target/docker/ || {
                  echo "âŒ zip è§£å‹å¤±è´¥"
                  exit 1
                }
                ;;
              *)
                echo "ğŸ“‹ ç›´æ¥å¤åˆ¶æ–‡ä»¶: $BUILD_FILE"
                mkdir -p target/docker/tinyMediaManager
                cp "$BUILD_FILE" target/docker/tinyMediaManager/
                ;;
            esac

            HAS_ARTIFACTS=true
          else
            echo "âš ï¸ ç›®å½•ä¸­æœªæ‰¾åˆ°å¯è¯†åˆ«çš„æ„å»ºäº§ç‰©æ–‡ä»¶"
            echo "ğŸ“ å°è¯•ç›´æ¥å¤åˆ¶æ•´ä¸ªç›®å½•å†…å®¹..."

            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šæ–‡ä»¶ï¼Œå°è¯•å¤åˆ¶æ•´ä¸ªç›®å½•
            if [ -d "$ARTIFACT_DIR" ]; then
              mkdir -p target/docker
              cp -r "$ARTIFACT_DIR"/* target/docker/ 2>/dev/null || {
                echo "âš ï¸ ç›´æ¥å¤åˆ¶å¤±è´¥"
                exit 1
              }

              # æ£€æŸ¥æ˜¯å¦æˆåŠŸå¤åˆ¶äº† tinyMediaManager ç›®å½•
              if [ -d "target/docker/tinyMediaManager" ]; then
                echo "âœ… æˆåŠŸå¤åˆ¶æ„å»ºäº§ç‰©ç›®å½•"
                HAS_ARTIFACTS=true
              else
                echo "âŒ æœªèƒ½æ‰¾åˆ° tinyMediaManager ç›®å½•"
                echo "ğŸ“ target/docker ç›®å½•å†…å®¹:"
                ls -la target/docker/
                exit 1
              fi
            else
              echo "âŒ æ„ä»¶ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•ï¼Œæ£€æŸ¥ artifacts ç›®å½•..."

          # æ£€æŸ¥ä¼ ç»Ÿçš„ artifacts ç›®å½•
          if [ -d "artifacts" ]; then
            echo "ğŸ“¦ å¤„ç† artifacts ç›®å½•..."
            cd artifacts
            echo "ğŸ“ artifacts ç›®å½•å†…å®¹:"
            ls -la .

            # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„æ„å»ºäº§ç‰©
            echo "ğŸ” æŸ¥æ‰¾ARM64æ„å»ºäº§ç‰©..."
            BUILD_FILES=$(find . -type f \( \
              -name "*linux*arm64*" -o \
              -name "*arm64*linux*" -o \
              -name "*tinymediamanager*arm64*" -o \
              -name "*tinymediamanager*linux*arm64*" -o \
              -name "tinymediamanager-linux-arm64*" \
            \) | head -10)
            echo "ğŸ” åœ¨artifactsç›®å½•ä¸­æŸ¥æ‰¾æ–‡ä»¶ç»“æœ: $BUILD_FILES"

            if [ -n "$BUILD_FILES" ]; then
              echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©:"
              echo "$BUILD_FILES"

              # å¤„ç†ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶
              BUILD_FILE=$(echo "$BUILD_FILES" | head -1)
              echo "ğŸ“¦ å¤„ç†æ–‡ä»¶: $BUILD_FILE"

              # åˆ›å»ºç›®æ ‡ç›®å½•
              mkdir -p ../target/docker/tinyMediaManager

              # æ ¹æ®æ–‡ä»¶ç±»å‹å¤„ç†
              case "$BUILD_FILE" in
                *.tar.*)
                  echo "ğŸ“¦ è§£å‹ tar æ–‡ä»¶: $BUILD_FILE"
                  tar xf "$BUILD_FILE" -C ../target/docker/ || {
                    echo "âŒ tar è§£å‹å¤±è´¥"
                    exit 1
                  }
                  ;;
                *.zip)
                  echo "ğŸ“¦ è§£å‹ zip æ–‡ä»¶: $BUILD_FILE"
                  unzip -q "$BUILD_FILE" -d ../target/docker/ || {
                    echo "âŒ zip è§£å‹å¤±è´¥"
                    exit 1
                  }
                  ;;
                *)
                  echo "ğŸ“‹ ç›´æ¥å¤åˆ¶æ–‡ä»¶: $BUILD_FILE"
                  cp "$BUILD_FILE" ../target/docker/tinyMediaManager/
                  ;;
              esac

              cd ..
              HAS_ARTIFACTS=true
            else
              echo "âŒ artifacts ç›®å½•ä¸­æœªæ‰¾åˆ°ä¸Šæ¸¸æ„å»ºäº§ç‰©"
              cd ..
              exit 1
            fi
          else
            echo "âŒ æ— ä¸Šæ¸¸æ„å»ºäº§ç‰©ï¼Œæ— æ³•ç»§ç»­æ„å»º"
            exit 1
          fi
        fi

        # éªŒè¯æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
        if [ "$HAS_ARTIFACTS" = "false" ]; then
          echo "âŒ æœªèƒ½æˆåŠŸå¤„ç†æ„å»ºäº§ç‰©"
          exit 1
        fi

        # æ˜¾ç¤ºæœ€ç»ˆç›®å½•ç»“æ„
        echo "ğŸ“ æœ€ç»ˆç›®å½•ç»“æ„:"
        find target/docker -type f

        # éªŒè¯tinyMediaManagerç›®å½•æ˜¯å¦å­˜åœ¨
        if [ ! -d "target/docker/tinyMediaManager" ]; then
          echo "âŒ æœªæ‰¾åˆ° tinyMediaManager ç›®å½•"
          echo "ğŸ’¡ è¯·æ£€æŸ¥æ„ä»¶æ˜¯å¦æ­£ç¡®ä¸‹è½½å’Œå¤„ç†"
          echo "ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š"
          echo "   1. ä¸Šæ¸¸å·¥ä½œæµæœªæä¾›æ­£ç¡®çš„æ„ä»¶"
          echo "   2. æ„ä»¶åç§°ä¸é¢„æœŸä¸åŒ¹é…"
          echo "   3. æ„ä»¶ä¸‹è½½å¤±è´¥"
          echo "   4. æ„ä»¶è§£å‹æˆ–å¤„ç†å¤±è´¥"
          exit 1
        fi

        # éªŒè¯tinyMediaManageräºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆæ”¯æŒæ¶æ„ç‰¹å®šå‘½åï¼‰
        if [ -f "target/docker/tinyMediaManager/tinyMediaManager" ]; then
          echo "âœ… æ‰¾åˆ° tinyMediaManager äºŒè¿›åˆ¶æ–‡ä»¶"
        elif [ -f "target/docker/tinyMediaManager/tinyMediaManager-arm" ]; then
          echo "ğŸ”„ é‡å‘½å ARM64 äºŒè¿›åˆ¶æ–‡ä»¶: tinyMediaManager-arm -> tinyMediaManager"
          mv target/docker/tinyMediaManager/tinyMediaManager-arm target/docker/tinyMediaManager/tinyMediaManager
          chmod +x target/docker/tinyMediaManager/tinyMediaManager
          echo "âœ… ARM64 äºŒè¿›åˆ¶æ–‡ä»¶é‡å‘½åå®Œæˆ"
        elif [ -f "target/docker/tinyMediaManager/tinyMediaManager-amd64" ]; then
          echo "ğŸ”„ é‡å‘½å AMD64 äºŒè¿›åˆ¶æ–‡ä»¶: tinyMediaManager-amd64 -> tinyMediaManager"
          mv target/docker/tinyMediaManager/tinyMediaManager-amd64 target/docker/tinyMediaManager/tinyMediaManager
          chmod +x target/docker/tinyMediaManager/tinyMediaManager
          echo "âœ… AMD64 äºŒè¿›åˆ¶æ–‡ä»¶é‡å‘½åå®Œæˆ"
        else
          echo "âŒ æœªæ‰¾åˆ° tinyMediaManager äºŒè¿›åˆ¶æ–‡ä»¶"
          echo "ğŸ“ tinyMediaManager ç›®å½•å†…å®¹:"
          ls -la target/docker/tinyMediaManager/
          echo "ğŸ’¡ è¯·æ£€æŸ¥æ„ä»¶æ˜¯å¦åŒ…å«æ­£ç¡®çš„äºŒè¿›åˆ¶æ–‡ä»¶"
          exit 1
        fi

        echo "âœ… æ„ä»¶å¤„ç†å®Œæˆï¼Œå‡†å¤‡æ„å»ºDockeré•œåƒ"

        # å¤åˆ¶Dockerfile
        if [ -f "src/docker/Dockerfile.arm64" ]; then
          cp src/docker/Dockerfile.arm64 target/docker/Dockerfile
          echo "âœ… æˆåŠŸå¤åˆ¶Dockerfile.arm64"
        else
          echo "âŒ æ— æ³•æ‰¾åˆ°src/docker/Dockerfile.arm64"
          echo "ğŸ“ src/dockerç›®å½•å†…å®¹:"
          ls -la src/docker/
          exit 1
        fi

        # äºŒè¿›åˆ¶æ–‡ä»¶é‡å‘½åå°†åœ¨éªŒè¯æ­¥éª¤ä¸­ç»Ÿä¸€å¤„ç†

        echo "âœ… Dockerä¸Šä¸‹æ–‡å‡†å¤‡å®Œæˆ"
        echo "ğŸ“ æœ€ç»ˆç›®å½•ç»“æ„:"
        find target/docker -type f

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push ARM64 image
      uses: docker/build-push-action@v5
      with:
        context: target/docker
        file: target/docker/Dockerfile
        platforms: linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.check-environment.outputs.version }}-arm64
        labels: |
          org.opencontainers.image.title=tinyMediaManager
          org.opencontainers.image.description=A comprehensive media management tool for organizing and managing your movie and TV show collections. Features automatic metadata fetching, artwork downloading, and extensive customization options.
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.url=https://www.tinymediamanager.org
          org.opencontainers.image.documentation=https://www.tinymediamanager.org/docs/docker
          org.opencontainers.image.licenses=Apache-2.0
          org.opencontainers.image.vendor=tinyMediaManager
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.version=${{ needs.check-environment.outputs.version }}

  # åˆ›å»ºå¤šæ¶æ„manifest
  create-manifest:
    name: Create Multi-Architecture Manifest
    runs-on: ubuntu-latest
    needs: [check-environment, docker-build-amd64, docker-build-arm64]
    if: |
      always() && (
        needs.docker-build-amd64.result == 'success' ||
        needs.docker-build-arm64.result == 'success'
      )
    permissions:
      contents: read
      packages: write

    steps:
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create and push manifest
      run: |
        echo "ğŸ³ åˆ›å»ºå¤šæ¶æ„manifest..."
        VERSION="${{ needs.check-environment.outputs.version }}"
        IS_RELEASE="${{ needs.check-environment.outputs.is-release }}"

        echo "ğŸ“‹ ç‰ˆæœ¬: $VERSION"
        echo "ğŸ·ï¸ æ˜¯å¦æ­£å¼ç‰ˆæœ¬: $IS_RELEASE"

        # æ£€æŸ¥é•œåƒå­˜åœ¨çš„å‡½æ•°
        check_image_exists() {
          local image_name="$1"
          local max_retries=3
          local retry_count=0
          
          echo "ğŸ” æ£€æŸ¥é•œåƒ: $image_name"
          
          while [ $retry_count -lt $max_retries ]; do
            if docker manifest inspect "$image_name" >/dev/null 2>&1; then
              echo "âœ… é•œåƒå­˜åœ¨: $image_name"
              return 0
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "âš ï¸ é•œåƒæ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $retry_count/$max_retries..."
                sleep 5
              fi
            fi
          done
          
          echo "âŒ é•œåƒä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: $image_name"
          return 1
        }

        # æ£€æŸ¥å¹¶æ‹‰å–å„ä¸ªæ¶æ„çš„é•œåƒ
        echo "ğŸ“¥ æ£€æŸ¥æ¶æ„ç‰¹å®šé•œåƒ..."
        AMD64_EXISTS=false
        ARM64_EXISTS=false

        if check_image_exists "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-amd64"; then
          AMD64_EXISTS=true
        fi

        if check_image_exists "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-arm64"; then
          ARM64_EXISTS=true
        fi

        # åˆ›å»ºmanifestçš„å‡½æ•°
        create_and_push_manifest() {
          local manifest_name="$1"
          local amd64_image="$2"
          local arm64_image="$3"
          local max_retries=3
          local retry_count=0
          
          echo "ğŸš€ åˆ›å»ºå¤šæ¶æ„ç‰ˆæœ¬manifest: $manifest_name"
          
          while [ $retry_count -lt $max_retries ]; do
            # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§manifest
            docker manifest rm "$manifest_name" 2>/dev/null || true
            
            # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
            if ! docker manifest inspect "$amd64_image" >/dev/null 2>&1; then
              echo "âŒ AMD64é•œåƒä¸å­˜åœ¨: $amd64_image"
              return 1
            fi
            
            if ! docker manifest inspect "$arm64_image" >/dev/null 2>&1; then
              echo "âŒ ARM64é•œåƒä¸å­˜åœ¨: $arm64_image"
              return 1
            fi
            
            echo "âœ… ä¸¤ä¸ªæ¶æ„é•œåƒéƒ½å­˜åœ¨"
            
            # ä½¿ç”¨buildx imagetoolsåˆ›å»ºmanifestï¼ˆæ›´robustçš„æ–¹æ³•ï¼‰
            echo "ğŸ”„ ä½¿ç”¨buildxåˆ›å»ºmanifest..."
            if docker buildx imagetools create \
              --tag "$manifest_name" \
              "$amd64_image" \
              "$arm64_image" 2>/dev/null; then
              echo "âœ… å¤šæ¶æ„ç‰ˆæœ¬manifeståˆ›å»ºæˆåŠŸ"
              return 0
            else
              echo "âš ï¸ buildxæ–¹æ³•å¤±è´¥ï¼Œå°è¯•ä¼ ç»Ÿæ–¹æ³•..."
              
              # å°è¯•ä¼ ç»Ÿmanifestæ–¹æ³•
              if docker manifest create --amend "$manifest_name" \
                "$amd64_image" \
                "$arm64_image"; then
                
                echo "ğŸ“¤ æ¨é€manifest: $manifest_name"
                if docker manifest push "$manifest_name"; then
                  echo "âœ… å¤šæ¶æ„ç‰ˆæœ¬manifestæ¨é€æˆåŠŸ"
                  return 0
                else
                  echo "âš ï¸ manifestæ¨é€å¤±è´¥"
                fi
              else
                echo "âš ï¸ manifeståˆ›å»ºå¤±è´¥"
              fi
            fi
            
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $max_retries ]; then
              echo "ğŸ”„ é‡è¯• $retry_count/$max_retries..."
              sleep 15
              # æ¸…ç†Dockerç¼“å­˜
              docker system prune -f --volumes 2>/dev/null || true
            fi
          done
          
          echo "âŒ manifeståˆ›å»ºå’Œæ¨é€æœ€ç»ˆå¤±è´¥"
          return 1
        }

        # ä¼˜é›…é™çº§å¤„ç†å‡½æ•°
        handle_single_architecture() {
          local arch="$1"
          local image_name="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
          local source_image="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-${arch}"
          
          echo "ğŸ·ï¸ åªæœ‰${arch}æ¶æ„é•œåƒï¼Œåˆ›å»ºå…¼å®¹ç‰ˆæœ¬: $VERSION"
          
          # åˆ›å»ºmanifestï¼ˆå•æ¶æ„ï¼‰
          if docker manifest create "$image_name" "$source_image" && \
             docker manifest annotate "$image_name" "$source_image" \
               --annotation "org.opencontainers.image.description=A comprehensive media management tool for organizing and managing your movie and TV show collections. Features automatic metadata fetching, artwork downloading, and extensive customization options." && \
             docker manifest push "$image_name"; then
            echo "âœ… å•æ¶æ„ç‰ˆæœ¬manifeståˆ›å»ºæˆåŠŸ: $arch"
            return 0
          else
            echo "âŒ å•æ¶æ„ç‰ˆæœ¬manifeståˆ›å»ºå¤±è´¥: $arch"
            return 1
          fi
        }

        # æ ¹æ®å¯ç”¨æ¶æ„åˆ›å»ºmanifestï¼ˆä¼˜é›…é™çº§ï¼‰
        if [ "$AMD64_EXISTS" = true ] && [ "$ARM64_EXISTS" = true ]; then
          if ! create_and_push_manifest "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}" \
               "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-amd64" \
               "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-arm64"; then
            echo "âŒ å¤šæ¶æ„ç‰ˆæœ¬manifeståˆ›å»ºå¤±è´¥"
            exit 1
          fi
        elif [ "$AMD64_EXISTS" = true ]; then
          if ! handle_single_architecture "amd64"; then
            exit 1
          fi
        elif [ "$ARM64_EXISTS" = true ]; then
          if ! handle_single_architecture "arm64"; then
            exit 1
          fi
        else
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ¶æ„çš„é•œåƒï¼Œè·³è¿‡manifeståˆ›å»º"
          echo "ğŸ’¡ è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› ï¼š"
          echo "   1. æ„ä»¶å¤„ç†å¤±è´¥ï¼ŒæœªæˆåŠŸæ„å»ºæ¶æ„ç‰¹å®šé•œåƒ"
          echo "   2. Dockeræ„å»ºæ­¥éª¤å¤±è´¥"
          echo "   3. ç½‘ç»œé—®é¢˜å¯¼è‡´é•œåƒæ¨é€å¤±è´¥"
          echo "   4. æƒé™é—®é¢˜å¯¼è‡´æ— æ³•è®¿é—®å®¹å™¨æ³¨å†Œè¡¨"
          exit 1
        fi

        # å•æ¶æ„latestå¤„ç†å‡½æ•°
        handle_single_architecture_for_latest() {
          local arch="$1"
          local image_name="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          local source_image="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-${arch}"
          
          if docker manifest create "$image_name" "$source_image" && \
             docker manifest annotate "$image_name" "$source_image" \
               --annotation "org.opencontainers.image.description=A comprehensive media management tool for organizing and managing your movie and TV show collections. Features automatic metadata fetching, artwork downloading, and extensive customization options." && \
             docker manifest push "$image_name"; then
            echo "âœ… latestæ ‡ç­¾åˆ›å»ºæˆåŠŸ: $arch"
            return 0
          else
            return 1
          fi
        }

        # åˆ›å»ºlatestæ ‡ç­¾çš„å‡½æ•°
        create_latest_manifest() {
          local max_retries=3
          local retry_count=0
          
          echo "ğŸ·ï¸ æ›´æ–°latestæ ‡ç­¾..."
          
          while [ $retry_count -lt $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "ğŸ”„ ç¬¬ $retry_count æ¬¡å°è¯•æ›´æ–°latestæ ‡ç­¾..."
            
            # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§latest manifest
            docker manifest rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest 2>/dev/null || true
            
            # æ¸…ç†Dockerç¼“å­˜
            docker system prune -f --volumes 2>/dev/null || true
            
            if [ "$AMD64_EXISTS" = true ] && [ "$ARM64_EXISTS" = true ]; then
              echo "ğŸš€ åˆ›å»ºå¤šæ¶æ„latest manifest..."
              if create_and_push_manifest "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" \
                   "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-amd64" \
                   "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-arm64"; then
                echo "âœ… latestæ ‡ç­¾æ›´æ–°æˆåŠŸ"
                return 0
              fi
            elif [ "$AMD64_EXISTS" = true ]; then
              echo "ğŸ·ï¸ åªæœ‰AMD64é•œåƒï¼Œåˆ›å»ºlatest"
              if handle_single_architecture_for_latest "amd64"; then
                return 0
              fi
            elif [ "$ARM64_EXISTS" = true ]; then
              echo "ğŸ·ï¸ åªæœ‰ARM64é•œåƒï¼Œåˆ›å»ºlatest"
              if handle_single_architecture_for_latest "arm64"; then
                return 0
              fi
            fi
            
            if [ $retry_count -lt $max_retries ]; then
              echo "âš ï¸ latestæ ‡ç­¾æ›´æ–°å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•..."
              sleep 15
            fi
          done
          
          echo "âŒ latestæ ‡ç­¾æ›´æ–°æœ€ç»ˆå¤±è´¥ï¼Œè·³è¿‡"
          return 1
        }

        # å§‹ç»ˆæ›´æ–°latest manifestï¼Œæ— è®ºåˆ†æ”¯ç±»å‹
        RELEASE_VERSION="${{ needs.check-environment.outputs.release-version }}"
        IS_TAG_BUILD="${{ needs.check-environment.outputs.release-version != '' }}"

        echo "ğŸ”„ æ›´æ–°latest manifestï¼ˆæ‰€æœ‰åˆ†æ”¯æ„å»ºï¼‰..."
        echo "ğŸ·ï¸ æ˜¯å¦Tagæ„å»º: $IS_TAG_BUILD"
        echo "ğŸ·ï¸ Releaseç‰ˆæœ¬: $RELEASE_VERSION"

        # æ— æ¡ä»¶åˆ›å»ºlatestæ ‡ç­¾
        create_latest_manifest || echo "âš ï¸ latestæ ‡ç­¾æ›´æ–°å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

        echo "âœ… å¤šæ¶æ„manifeståˆ›å»ºå®Œæˆ"
        echo "ğŸ‰ Dockeré•œåƒæ„å»ºå’Œæ¨é€å…¨éƒ¨å®Œæˆ"



        # è·å–è¿œç¨‹ tagsï¼ˆå¤„ç†gitä»“åº“é—®é¢˜ï¼‰
        if git rev-parse --git-dir >/dev/null 2>&1; then
          git fetch --tags
          REMAINING_TAGS=$(git tag -l | grep -E '^v' || echo "")

          if [ -n "$REMAINING_TAGS" ]; then
            echo "âœ… å‰©ä½™çš„ tags:"
            echo "$REMAINING_TAGS"
          else
            echo "âš ï¸ æ²¡æœ‰å‰©ä½™çš„ tags"
          fi
        else
          echo "âš ï¸ égitä»“åº“ç¯å¢ƒï¼Œè·³è¿‡tagæ£€æŸ¥"
        fi

        echo ""
        echo "âœ… æ¸…ç†å®Œæˆï¼åªä¿ç•™æœ€æ–°ç‰ˆæœ¬"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


