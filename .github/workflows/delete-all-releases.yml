name: Delete All Releases

on:
  workflow_dispatch:
    inputs:
      confirm_deletion:
        description: 'ç¡®è®¤åˆ é™¤æ‰€æœ‰releases (è¾“å…¥ DELETE_ALL_RELEASES ç¡®è®¤)'
        required: true
        type: string
      delete_tags:
        description: 'åŒæ—¶åˆ é™¤å¯¹åº”çš„Git tags'
        required: true
        default: true
        type: boolean
  workflow_call:
    inputs:
      delete_tags:
        description: 'åŒæ—¶åˆ é™¤å¯¹åº”çš„Git tags'
        required: false
        default: true
        type: boolean

jobs:
  delete-releases:
    name: Delete All GitHub Releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate confirmation
      run: |
        # æ£€æŸ¥æ˜¯å¦ä¸ºå·¥ä½œæµè°ƒç”¨ï¼ˆé€šè¿‡inputså‚æ•°åˆ¤æ–­ï¼‰
        if [ -z "${{ github.event.inputs.confirm_deletion }}" ]; then
          echo "âœ… å·¥ä½œæµè°ƒç”¨ï¼Œè‡ªåŠ¨ç¡®è®¤åˆ é™¤æ“ä½œ"
          echo "ğŸ” äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
          echo "ğŸ” è°ƒç”¨æ–¹å¼: workflow_call"
        elif [ "${{ github.event.inputs.confirm_deletion }}" != "DELETE_ALL_RELEASES" ]; then
          echo "âŒ ç¡®è®¤æ–‡æœ¬ä¸æ­£ç¡®ï¼Œæ“ä½œå·²å–æ¶ˆ"
          echo "è¯·è¾“å…¥: DELETE_ALL_RELEASES"
          exit 1
        else
          echo "âœ… ç¡®è®¤æ–‡æœ¬æ­£ç¡®ï¼Œç»§ç»­æ‰§è¡Œåˆ é™¤æ“ä½œ"
        fi

    - name: Get all releases
      id: get-releases
      run: |
        echo "ğŸ” è·å–æ‰€æœ‰ releases..."
        
        # ä½¿ç”¨ GitHub API è·å–æ‰€æœ‰ releases
        RELEASES=$(gh api repos/${{ github.repository }}/releases --paginate --jq '.[].tag_name')
        
        if [ -z "$RELEASES" ]; then
          echo "âœ… æ²¡æœ‰æ‰¾åˆ°ä»»ä½• releases"
          echo "has_releases=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ğŸ“‹ æ‰¾åˆ°ä»¥ä¸‹ releases:"
        echo "$RELEASES"
        
        # è®¡ç®— releases æ•°é‡
        RELEASE_COUNT=$(echo "$RELEASES" | wc -l)
        echo "ğŸ“Š æ€»è®¡: $RELEASE_COUNT ä¸ª releases"
        
        echo "has_releases=true" >> $GITHUB_OUTPUT
        echo "release_count=$RELEASE_COUNT" >> $GITHUB_OUTPUT
        
        # ä¿å­˜ release tags åˆ°æ–‡ä»¶
        echo "$RELEASES" > release_tags.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Delete all releases
      if: steps.get-releases.outputs.has_releases == 'true'
      run: |
        echo "ğŸ—‘ï¸ å¼€å§‹åˆ é™¤æ‰€æœ‰ releases..."
        echo "æ€»è®¡éœ€è¦åˆ é™¤: ${{ steps.get-releases.outputs.release_count }} ä¸ª"
        echo ""
        
        SUCCESS_COUNT=0
        FAILED_COUNT=0
        
        while IFS= read -r tag; do
          if [ -n "$tag" ]; then
            echo "ğŸ—‘ï¸ åˆ é™¤ release: $tag"
            
            if gh release delete "$tag" --yes 2>/dev/null; then
              echo "âœ… æˆåŠŸåˆ é™¤ release: $tag"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "âŒ åˆ é™¤ release å¤±è´¥: $tag"
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
            
            # æ·»åŠ å»¶è¿Ÿé¿å… API é™åˆ¶
            sleep 1
          fi
        done < release_tags.txt
        
        echo ""
        echo "ğŸ“Š Release åˆ é™¤ç»Ÿè®¡:"
        echo "âœ… æˆåŠŸåˆ é™¤: $SUCCESS_COUNT ä¸ª"
        echo "âŒ åˆ é™¤å¤±è´¥: $FAILED_COUNT ä¸ª"
        
        # ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_ENV
        echo "failed_count=$FAILED_COUNT" >> $GITHUB_ENV
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Delete corresponding tags
      if: steps.get-releases.outputs.has_releases == 'true' && (github.event.inputs.delete_tags == 'true' || (github.event.inputs.confirm_deletion == '' && inputs.delete_tags == true))
      run: |
        echo "ğŸ·ï¸ å¼€å§‹åˆ é™¤å¯¹åº”çš„ Git tags..."
        echo ""
        
        TAG_SUCCESS_COUNT=0
        TAG_FAILED_COUNT=0
        
        while IFS= read -r tag; do
          if [ -n "$tag" ]; then
            echo "ğŸ—‘ï¸ åˆ é™¤ tag: $tag"
            
            if git rev-parse --git-dir >/dev/null 2>&1; then
            if git push origin --delete "$tag" 2>/dev/null; then
              echo "âœ… æˆåŠŸåˆ é™¤ tag: $tag"
              TAG_SUCCESS_COUNT=$((TAG_SUCCESS_COUNT + 1))
            else
              echo "âŒ åˆ é™¤ tag å¤±è´¥: $tag (å¯èƒ½å·²ä¸å­˜åœ¨)"
              TAG_FAILED_COUNT=$((TAG_FAILED_COUNT + 1))
            fi
          else
            echo "âš ï¸ égitä»“åº“ç¯å¢ƒï¼Œè·³è¿‡tagåˆ é™¤: $tag"
            TAG_FAILED_COUNT=$((TAG_FAILED_COUNT + 1))
          fi
            
            # æ·»åŠ å»¶è¿Ÿ
            sleep 0.5
          fi
        done < release_tags.txt
        
        echo ""
        echo "ğŸ“Š Tag åˆ é™¤ç»Ÿè®¡:"
        echo "âœ… æˆåŠŸåˆ é™¤: $TAG_SUCCESS_COUNT ä¸ª"
        echo "âŒ åˆ é™¤å¤±è´¥: $TAG_FAILED_COUNT ä¸ª"

    - name: Verify deletion
      if: steps.get-releases.outputs.has_releases == 'true'
      run: |
        echo "ğŸ” éªŒè¯åˆ é™¤ç»“æœ..."
        
        # æ£€æŸ¥å‰©ä½™çš„ releases
        REMAINING_RELEASES=$(gh api repos/${{ github.repository }}/releases --jq '.[].tag_name' 2>/dev/null || echo "")
        
        if [ -z "$REMAINING_RELEASES" ]; then
          echo "âœ… æ‰€æœ‰ releases å·²æˆåŠŸåˆ é™¤"
        else
          echo "âš ï¸ ä»æœ‰ä»¥ä¸‹ releases å­˜åœ¨:"
          echo "$REMAINING_RELEASES"
        fi
        
        # æ£€æŸ¥å‰©ä½™çš„ tagsï¼ˆå¦‚æœé€‰æ‹©åˆ é™¤ tagsï¼‰
        if [ "${{ github.event.inputs.delete_tags }}" = "true" ]; then
          echo ""
          echo "ğŸ·ï¸ æ£€æŸ¥å‰©ä½™çš„ tags..."
          
          # è·å–è¿œç¨‹ tags
          if git rev-parse --git-dir >/dev/null 2>&1; then
            git fetch --tags
            REMAINING_TAGS=$(git tag -l | grep -E '^v[0-9]' || echo "")
          else
            echo "âš ï¸ égitä»“åº“ç¯å¢ƒï¼Œè·³è¿‡tagæ£€æŸ¥"
            REMAINING_TAGS=""
          fi
          
          if [ -z "$REMAINING_TAGS" ]; then
            echo "âœ… æ‰€æœ‰ç›¸å…³ tags å·²æˆåŠŸåˆ é™¤"
          else
            echo "âš ï¸ ä»æœ‰ä»¥ä¸‹ tags å­˜åœ¨:"
            echo "$REMAINING_TAGS"
          fi
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ‰ åˆ é™¤æ“ä½œå®Œæˆï¼"
        echo "================================"
        
        if [ "${{ steps.get-releases.outputs.has_releases }}" = "true" ]; then
          echo "ğŸ“Š æ“ä½œç»Ÿè®¡:"
          echo "- åŸå§‹ releases æ•°é‡: ${{ steps.get-releases.outputs.release_count }}"
          echo "- æˆåŠŸåˆ é™¤ releases: ${success_count:-0}"
          echo "- åˆ é™¤å¤±è´¥ releases: ${failed_count:-0}"
          
          if [ "${{ github.event.inputs.delete_tags }}" = "true" ]; then
            echo "- åŒæ—¶åˆ é™¤äº†å¯¹åº”çš„ Git tags"
          else
            echo "- ä¿ç•™äº†å¯¹åº”çš„ Git tags"
          fi
        else
          echo "ğŸ“‹ æ²¡æœ‰æ‰¾åˆ°ä»»ä½• releases éœ€è¦åˆ é™¤"
        fi
        
        echo ""
        echo "âš ï¸ æ³¨æ„: æ­¤æ“ä½œä¸å¯é€†ï¼Œå·²åˆ é™¤çš„ releases æ— æ³•æ¢å¤"
